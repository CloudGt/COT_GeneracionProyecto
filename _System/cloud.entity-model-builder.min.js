/*!
* Cloud On Time - Model Builder
* Copyright 2008-2020 Code On Time LLC; Licensed MIT; http://codeontime.com/license
*/
(function(){function ni(){$(".cloud-model-menu").length&&$(".cloud-model-modal-background").trigger("click")}function ti(n){return!$(n.target).closest("[data-input]").find(".cloud-model-input").length}function ii(n){return n.which===1&&ti(n)}function p(n){return n!=null&&typeof n!="string"&&(n=n.toString()),n?n.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):n}function w(n){return n==null||!n.length}function ri(n,t,i){var r=i.split(/\n/g),o;t+=23;u||(u=$('<div class="cloud-tooltip"><\/div>').appendTo(document.body).hide());u.text(i);r&&(i.match(/\t/)?(o=$("<table/>").appendTo(u.empty()),$(r).each(function(){var n=this.split(/\t/g),t=$("<tr/>").appendTo(o);$(n).each(function(){var n=this,i=$("<td/>").appendTo(t);n.match(/\"/)?i.html(n.replace(/"(.+?)"/g,"<b>$1<\/b>")):i.text(n)})})):(u.empty(),$(r).each(function(n){var t=this;n&&$("<br/>").appendTo(u);t.match(/\"/)&&(t=t.replace(/"(.+?)"/g,"<b>$1<\/b>"));$("<span/>").appendTo(u).html(t)})));u.css({left:0,top:0}).show();f.scrollLeft()+n+u.outerWidth()>=f.scrollLeft()+f.width()&&(n=f.scrollLeft()+f.width()-u.outerWidth()-16);f.scrollTop()+t+u.outerHeight()>=f.scrollTop()+f.height()&&(t=e-5-u.outerHeight());u.css({left:n-5,top:t})}function oi(n){function c(){e.off().find("li").removeData();t.remove();h.off().remove();$(".cloud-model-inspected").removeClass("cloud-model-inspected");yt(".cloud-model-inspected","cloud-model-inspected")}var h=$('<div class="cloud-model-modal-background cloud-model-noselect"><\/div>').appendTo(rt),t=$('<div class="cloud-model-menu"><\/div>').appendTo(rt),e=$("<ul/>").appendTo(t),i=$('<div class="cloud-model-popup-arrow"><\/div>').insertBefore(e),o,s,r,u;n.title?$("<h1/>").insertBefore(e).text(n.title):t.addClass("cloud-model-menu-notitle");$(n.items).each(function(){var n=this,t=$("<li/>").appendTo(e);t.text(n.text).data("item",n)});t.on("contextmenu",function(){return!1});h.on("click contextmenu",function(){return setTimeout(c,10),!1});e.on("click",function(n){var i=$(n.target).closest("li"),t=i.data("item");setTimeout(function(){t&&(c(),t.callback&&t.callback(t.context))},10)});o=t.outerWidth(!0);n.hideArrow?n.y-=i.outerHeight(!0)+2:n.x-=o/2;n.x<0&&(r=-n.x,n.x=1);s=t.outerHeight(!0);n.x+o>f.width()-1&&(r=n.x-(f.width()-o-1),n.x-=r,r=-1*r);n.y+s>f.height()-1?(u=s,n.hideArrow?u-=i.outerHeight()-2:t.addClass("cloud-model-menu-above"),n.y-=u,u=-1*u):n.y++;n.y<0&&(u=-n.y,n.y=1,i.remove());n.hideArrow&&i.remove();t.css({left:n.x,top:n.y});i.length&&i.css({marginLeft:parseInt(i.css("marginLeft"))-r})}function nt(n){var i=!0,t;if(n)setTimeout(function(){nt()},5);else try{r.getSelection?(t=r.getSelection(),t&&t.rangeCount>0&&t.removeAllRanges()):document.selection&&document.selection.empty()}catch(u){i=!1}return i}function t(){return $(".cloud-model-diagram").data("builder")}function ui(){$(".cloud-model-panel-formula:visible").each(function(){var n=$(this).data("editor");n.refresh()})}function at(n,i){if($(".cloud-model-highlight").removeClass("cloud-model-highlight"),arguments.length){var r=(i||t()._fieldGrid)._grid.find('[data-field="'+n+'"] [data-column="FieldName"]').addClass("cloud-model-highlight");clearTimeout(dt);dt=setTimeout(function(){r.removeClass("cloud-model-highlight")},1500)}}function s(n,t){var i=n;return i?i+=".":i="",i+t}function tt(n,t){var i=n.type;return n.length!=null&&n.length!=1073741823&&n.length!=2147483647&&(i+="("+n.length+")"),n.identity&&t!=!1&&(i+=" identity"),i}function vt(n){var i=n.type,t=n.dataType;return i.match(/money/i)||!t.match(/date|string/i)&&n.name.match(/price|cost|salary/i)?"c":t=="DateTime"?"g":null}function it(n,t){$(n).each(function(){var i=this,n=i.getAttribute("class").split(/\s+/g);n.indexOf(t)==-1&&(n.push(t),i.setAttribute("class",n.join(" ")))})}function ut(n,r){var c=0,e=t(),s,u,o,h=n.find(".cloud-model-column-hidden"),l=n.find(".cloud-model-column-selected"),a=r&&l.length==1?c:0,f=n.find(".cloud-model-column:not(.cloud-model-column-selected):not(.cloud-model-column-pk):not(.cloud-model-column-fk)");if(f.length>a){if(u=l.length>1?f.length:Math.min(f.length,f.length-c),u<=0&&(u=f.length),r&&u==1)return;r&&$('<tr class="cloud-model-column-visibility"><td><\/td><td colspan="2"><span class="cloud-model-column-visibility-toggle"><\/span><\/td><\/tr>').appendTo(n);o=n.find(".cloud-model-column-visibility-toggle");h.length?(h.removeClass("cloud-model-column-hidden"),o.text("less").attr("title","Show Less Columns")):o.length&&(f.slice(-u).addClass("cloud-model-column-hidden"),o.text("+"+u+" more").attr("title","Show More Columns"))}else r||(h.removeClass("cloud-model-column-hidden"),n.find(".cloud-model-column-visibility").remove());r||(modelBuilder_hideTooltip(),s=e._diagram.closest(".cloud-model-container"),e.diagramHeight(s.scrollTop()+n.offset().top+n.outerHeight()-s.offset().top+i),requestAnimationFrame(function(){e.scale(!1);e.updateConnectors();e.scale(!0)}))}function yt(n,t){$(n).each(function(){var i=this,n=i.getAttribute("class").split(/\s+/g),r=n.indexOf(t);r!=-1&&(n.splice(r,1),i.setAttribute("class",n.join(" ")))})}function b(n){var t,r,i;if(n&&(t=n.element,t?r=!0:(t=n.type,t&&(t=document.createElementNS(wt,t))),t))for(key in n)switch(key){case"type":case"element":break;case"parent":n.parent.appendChild(t);break;case"children":i=n[key];i&&$(i).each(function(){var n=this,i;n.parent=t;i=b(n);t.appendChild(i)});break;default:t.setAttribute(key,n[key])}return r&&t.parentNode.insertBefore(t,t),t}function v(){clearTimeout(ht);$(".cloud-model-has-dependency").length&&(yt(".cloud-model-connector.cloud-model-dependency","cloud-model-dependency"),$(".cloud-model-has-dependency").removeClass("cloud-model-has-dependency"),$(".cloud-model-dependency").removeClass("cloud-model-dependency"))}function pt(){clearTimeout(st);$(".cloud-model-dependency,.cloud-model-tracking").removeClass("cloud-model-dependency cloud-model-tracking")}function fi(n){if(lt)return!1;var t=n.closest("[data-input]"),o=t.contents(),s=t.outerHeight(),u,i,f,r,e;return t.find("[data-input-hotspot]").length&&!n.is("[data-input-hotspot]")||$(".cloud-model-input").length?!1:(u=$('<div class="cloud-model-input-container"><\/div>'),i=$('<input type="text" class="cloud-model-input"/>').appendTo(u),o.css("visibility","hidden"),u.appendTo(t).height(s-1),r=$.Event("getvalue.input.app",{inputValue:null,inputElement:i.get(0)}),t.trigger(r),r.inputElement=null,f=r.inputValue||"",i.val(f).data("original",f),e=$.Event("beforefocus.input.app",{inputElement:i.get(0)}),t.trigger(e),e.inputElement=null,i.focus().select(),!0)}function d(n){return n===!0||n==="true"||n==="row"?"check_circle":"radio_button_unchecked"}function k(n){return modelBuilder_hideTooltip(),$(n).closest(".cloud-model-panel-masterdetail").data("builder")}function ft(n,t){var i=k(n),r=$(n).closest("[data-detail-index]").data("detail-index"),u={model:i._model,detail:i._model.details[r],index:r};return t?u:u.detail}var r=window,f=$(r),rt=$(document.body),wt="http://www.w3.org/2000/svg",i=20,h=60,o,e,bt=500,u,et,ot,kt,dt,st,gt,ei,c,l,ht,n,ct,a=30,lt,y,g=$('<div class="app-scrollbar-info"><div><\/div><\/div>').appendTo(rt);c={width:g[0].offsetWidth-g[0].clientWidth,height:g[0].offsetWidth-g[0].clientWidth};g.remove();r.modelBuilder_moveField=function(n,i,r){var u=t();r=="before"?u.moveFieldBefore(n,i):u.moveFieldAfter(n,i)};r.modelBuilder_focusDiagram=function(){$(".cloud-model-container").focus()};r.modelBuilder_scaleDiagram=function(n){t().scale(n);modelBuilder_focusDiagram()};r.modelBuilder_entityIdentityFieldName=function(){var r=t(),n,i;return r._fieldGrid._tableBody.find('[data-column="Spec"]').each(function(){var t=$(this);if(t.text().match(/\bV?PK\b/i))i=!0;else return n=t.parent().find('[data-column="FieldName"]').text(),!1}),i?n:null};r.modelBuilder_JsonDataModel=function(){return JSON.stringify(t().finalDataModel())};r.modelBuilder_hideTooltip=function(){$(u).hide();clearTimeout(et)};r.modelBuilder_pauseMouseEvents=function(){y=!0;modelBuilder_hideTooltip();setTimeout(function(){y=!1},500)};r.modelBuilder_arrangeTables=function(){t().arrange()};r.modelBuilder_addTable=function(n){var i=t();return i?i.addTable(n):!1};r.modelBuilder_formulaField=function(n){var i=t();return i?i.formulaField(n):!1};r.modelBuilder_whereClause=function(n){var i=t();return i?arguments.length?i.whereClause(n):i.whereClause():!1};r.modelBuilder_masterDetail=function(n){var i=t();return i?i.masterDetail(n):!1};r.modelBuilder_showFieldOnDiagram=function(n){var i,u,s,r,c,p,e,o,l,f,h,a,v,y;typeof n=="string"&&(pt(),i=t(),u=i._fieldGrid,c=u.findRowIndex({FieldName:n}),n=u._fixedTableBody.find("tr:eq("+c+') [data-column="FieldName"]'),r=u._options.rows[c],$(".cloud-model-inspected").length||i.scrollFieldIntoView(r.SqlFormula?{fieldName:r.FieldName}:{tableAlias:r.TableAlias,tableName:r.TableName,columnName:r.ColumnName}));u=n.closest(".cloud-grid");u.length&&(p=n.offset(),i||(i=u.closest(".cloud-model-list").data("builder")),r=i._fieldGrid._options.rows[n.parent().index()],y=r.TableAlias,s=i._diagram.find((y!=i._model.alias?'[data-foreign-key="'+y+'"]':".cloud-model-table-base")+' [data-column="'+r.ColumnName+'"]'),s.length&&(e=s.closest(".cloud-model-container"),o=e.offset(),l=e.height(),scrollableWidth=e.width(),f=s.offset(),h=s[0].getBoundingClientRect(),s.addClass("cloud-model-tracking"),i._fieldGrid._fixedTableBody.find("tr:eq("+n.closest("tr").index()+")").addClass("cloud-model-dependency"),i._fieldGrid._tableBody.find("tr:eq("+n.closest("tr").index()+")").addClass("cloud-model-dependency"),(f.top<o.top||f.top+h.height>o.top+l)&&(v=e.scrollTop()+f.top-o.top-(l-h.height)/2),(f.left<o.left||f.left+h.width>o.left+scrollableWidth)&&(a=e.scrollLeft()+f.left-o.left-(scrollableWidth-h.width)/2),(a!=null||v!=null)&&e.animate({scrollTop:v,scrollLeft:a},{duration:300,queue:!1})))};$(document).on("contextmenu",".cloud-model-container,.cloud-model-list",function(n){if(ti(n))return l=null,t().showContextMenu(n),!1}).on("mousemove",function(r){var w,nt,k,tt,rt,h,c;if(r.pageX!=null&&(o=r.pageX,e=r.pageY),l&&(Math.abs(o-l.x)>5||Math.abs(e-l.y))&&(n=l,n.element.addClass("cloud-model-dragging"),l=null,pt(),v(),modelBuilder_hideTooltip()),n){if(r.pageX!=null){clearTimeout(ct);var y=$(n.element).closest(".cloud-model-container,.cloud-grid"),b,u=0,s=0;y.length&&(b=y.offset(),o-b.left<=a&&(u=-a),b.left+y.width()-o<a&&(u=a),e-b.top<=a&&(s=-a),b.top+y.height()-e<a&&(s=a),(u!=0||s!=0)&&(ct=setInterval(function(){var t=y.scrollLeft(),i=y.scrollTop();t+u<0&&(u=t);i+s<0&&(s=0);u!=i&&(n.offsetX-=u);s!=0&&(n.offsetY-=s);(u!=0||s!=0)&&$(document).trigger("mousemove");u!=0&&y.scrollLeft(t+u);s!=0&&y.scrollTop(i+s)},100)))}if(n.type=="divider"&&(r.preventDefault(),w=n.canceled?n.originalY:(r.originalEvent?r.originalEvent.pageY:1e4)-19,nt=f.height(),w<101?w=101:nt-w<150&&(w=nt-150),k=n.data.css("height",w),tt=k.offset().top+k.outerHeight(!0),rt=n.element.css("top",tt),n.element.next().css("top",tt+rt.outerHeight(!0)),k.parent().find(".cloud-model-panel").height(k.outerHeight(!0)),ui()),n.type=="table"){r.preventDefault();r.stopPropagation();h=t();c=h._scaleRatio;c!=1&&h.scale(!1);var p=n.element,it=h._foreignKeyMap[p.attr("data-foreign-key")],d=o-n.data.left-n.offsetX,g=e-n.data.top-n.offsetY,ut=Math.ceil(d/c+p.outerWidth()+i),ft=Math.ceil(g/c+p.outerHeight()+i);n.canceled?(p.css({left:n.originalX/c,top:n.originalY/c}),p.closest(".cloud-model-container").scrollLeft(n.originalScrollLeft).scrollTop(n.originalScrollTop)):(h.diagramWidth(ut),h.diagramHeight(ft),d/=c,g/=c,p.css({left:d,top:g}),it?(it.x=d,it.y=g):(h._model.x=d,h._model.y=g));h.updateConnectors([p.attr("data-foreign-key")||""]);c!=1&&h.scale(!0)}}}).on("mouseup",function(t){if(l=null,n){var i;n.type=="divider"&&(y=!1,i=!0,$(".cloud-model-container svg").css("visibility",""));n.type=="table"&&(i=!0);i&&(t.preventDefault(),lt=!0,setTimeout(function(){lt=!1},100));$(document).trigger("dragend")}}).on("keypress",function(t){var i=t.which==27;(i&&ni(),n)&&i&&(n.canceled=!0,$(document).trigger("mousemove",t).trigger("mouseup",t),t.preventDefault())}).on("click",".cloud-model-table-list li",function(n){var i=$(n.target).closest("li"),r={name:i.attr("data-table"),schema:i.attr("data-schema")};n.preventDefault();setTimeout(function(){t().addTable(r)})}).on("click",".cloud-model-column-name",function(n){modelBuilder_hideTooltip();var u=$(n.target),t=u.closest("tr"),f=$(this).find(":input"),i=f.prop("checked"),e=t.closest(".cloud-model-diagram").data("builder"),r=t.closest(".cloud-model-table"),s=r.attr("data-foreign-key"),h=t.attr("data-column"),o={columnName:h,tableAlias:s,tableName:r.attr("data-table"),schema:r.attr("data-schema")};i=u.is(":input")?f.prop("checked"):!i;setTimeout(function(){i?e.addField(o):e.removeField(o)},10)}).on("click",".cloud-model-column-visibility-toggle",function(n){setTimeout(function(){ut($(n.target).closest(".cloud-model-table"))},100)}).on("mouseenter mousemove","[title]",function(t,i){if(!n){var r=$(this),f=r.attr("title"),h=o,c=e;if(f){if(y){f&&(r.attr("title",null),setTimeout(function(){r.attr("title",f)},1e3));return}r.attr("title","").data("title",f);clearTimeout(et);et=setTimeout(function(){var i=r.offset(),l,a;if(r[0].namespaceURI==wt&&Math.abs(h-o)<=11&&Math.abs(c-e)<=11||o>=i.left&&o<i.left+r.outerWidth(!0)&&e>=i.top&&e<i.top+r.outerHeight(!0)){ri(o,e,f);var n=r.closest(".cloud-model-diagram"),t=n.data("builder"),y=r.attr("data-connector"),p,w,b;y?(v(),p=t._foreignKeyMap[y],w=n.find('[data-foreign-key="'+y+'"]'),b=p.baseForeignKey?n.find('[data-table][data-foreign-key="'+p.baseForeignKey+'"]'):n.find('[data-table="'+t._model.baseTable+'"][data-schema="'+t._model.baseSchema+'"]'),it(r,"cloud-model-dependency"),w.addClass("cloud-model-dependency"),b.addClass("cloud-model-dependency"),n.addClass("cloud-model-has-dependency")):(l=r.closest(".cloud-model-column"),a=l.closest(".cloud-model-table"),l.length&&t.scrollFieldIntoView({tableAlias:a.attr("data-foreign-key")||t._model.alias,tableName:s(a.attr("data-schema"),a.attr("data-table")),columnName:l.attr("data-column")}))}else $(u).hide()},i!=null?i:bt)}}}).on("mouseleave","[title]",function(){if(!n){var t=$(this),i=t.data("title");i&&t.attr("title",i);modelBuilder_hideTooltip()}}).on("mouseenter","[data-table][data-foreign-key]",function(){if(!y&&!n){var t=$(this);clearTimeout(ht);v();$(u).hide();ht=setTimeout(function(){var f=t.addClass("cloud-model-dependency").closest(".cloud-model-diagram").addClass("cloud-model-has-dependency").data("builder"),r=f._diagram,e=t.attr("data-foreign-key"),n=f._foreignKeyMap[e],o=n.foreignKey,i=n.baseForeignKey,u;for(it(r.find('[data-connector="'+e+'"]'),"cloud-model-dependency");i;)u=r.find('[data-table][data-foreign-key="'+i+'"]').addClass("cloud-model-dependency"),$(o).each(function(){u.find('[data-column="'+this.columnName+'"]').addClass("cloud-model-dependency")}),i=n.baseForeignKey,i&&(o=n.foreignKey,n=f._foreignKeyMap[i],it(r.find('[data-connector="'+i+'"]'),"cloud-model-dependency"));n&&(u=r.find(".cloud-model-table-base").addClass("cloud-model-dependency"),$(n.foreignKey).each(function(){u.find('[data-column="'+this.columnName+'"]').addClass("cloud-model-dependency")}))},1e3)}}).on("mouseleave","[data-table][data-foreign-key]",function(){n||v()}).on("mouseenter",".cloud-grid tbody td",function(){if(!y&&!n){var t=$(this),i=t.attr("data-column");(i=="RowNumber"||i=="FieldName")&&(clearTimeout(st),st=setTimeout(function(){var n=t.offset();n.left<=o&&o<n.left+t.outerWidth()&&n.top<=e&&e<=n.top+t.outerHeight()&&modelBuilder_showFieldOnDiagram(t)},bt))}}).on("click",".cloud-grid tbody td",function(){var i=$(this),n,r;i.is('[data-column="SqlFormula"]')?(r=t(),n=r._fieldGrid.findRow({FieldName:i.parent().attr("data-field")}),n.SqlFormula&&r.formulaField({fieldName:n.FieldName,formula:n.SqlFormula})):modelBuilder_showFieldOnDiagram(i)}).on("mouseleave","[data-column]",function(){if(!n){var u=$(this),t=u.closest(".cloud-model-diagram,.cloud-model-list").data("builder"),i,r;t&&(i=t._fieldGrid._grid.find(".cloud-model-dependency"),r=t._diagram.find(".cloud-model-tracking"),setTimeout(function(){i.removeClass("cloud-model-dependency");$(".cloud-model-inspected").length||r.removeClass("cloud-model-tracking")},500))}}).on("mousedown",".cloud-model-table th",function(n){if(ii(n)){nt(!0);var t=$(this).closest(".cloud-model-table"),r=t.closest(".cloud-model-container"),e=r.offset(),i=t.offset(),u=r.scrollTop(),f=r.scrollLeft(),o=n.pageX,s=n.pageY;l={type:"table",element:t,data:t.closest(".cloud-model-container").offset(),x:o,offsetX:o-i.left-f,y:s,offsetY:s-i.top-u,originalScrollLeft:f,originalScrollTop:u,originalX:i.left-e.left+f,originalY:i.top-e.top+u}}}).on("mousedown",".cloud-divider-horizontal",function(i){if(ii(i)){nt(!0);var r=$(this).addClass("cloud-model-dragging");n={type:"divider",element:r,data:r.prev().find(".cloud-grid"),originalY:r.offset().top};i.preventDefault();y=!0;(t().hosted()||!0)&&$(".cloud-model-container svg").css("visibility","hidden")}}).on("dragstart",'.cloud-model-list [data-column="FieldName"],.cloud-model-table .cloud-model-column-name',function(t){if(!nt()){nt(!0);return}pt();at();var i=$(this),f=t.originalEvent.dataTransfer,r=i.closest(".cloud-model-table"),u=i.closest(".cloud-model-column-name");u.length&&(i=u);u.length?(n={type:"column",data:{column:i.closest(".cloud-model-column").attr("data-column"),alias:r.attr("data-foreign-key"),table:r.attr("data-table"),schema:r.attr("data-schema")},element:i},v(),modelBuilder_hideTooltip()):(f.effectAllowed="move",n={type:"field",data:i.text(),element:i});n.element.addClass("cloud-model-dragging")}).on("dragstart",".cloud-model-table-list [data-table]",function(i){var r=$(this),u=r.offset(),f=i.originalEvent,e=t()._scaleRatio;n={type:"tableName",data:{name:r.attr("data-table"),schema:r.attr("data-schema"),x:-(f.pageX-u.left)*e,y:-(f.pageY-u.top)*e}};i.originalEvent.dataTransfer.effectAllowed="copy";modelBuilder_hideTooltip()}).on("dragover",".cloud-model-list td",function(t){n&&n.type=="field"&&$(t.target).parent().attr("data-field")!=n.data&&(t.originalEvent.dataTransfer.dropEffect="copy",t.preventDefault())}).on("dragover",".cloud-model-list",function(t){n&&n.type=="column"&&(t.originalEvent.dataTransfer.dropEffect="move",t.preventDefault())}).on("dragover",".cloud-model-container",function(i){n&&(n.type=="column"?t().linkTables(i.target,i.ctrlKey)&&(i.originalEvent.dataTransfer.dropEffect="link",i.preventDefault()):n.type=="tableName"&&(i.originalEvent.dataTransfer.dropEffect="copy",i.preventDefault()))}).on("dragover",".CodeMirror",function(t){n&&n.type=="column"&&(t.originalEvent.dataTransfer.dropEffect="link",t.preventDefault())}).on("drop",".CodeMirror",function(i){if(n&&n.type=="column"){var f=$(i.target).closest(".cloud-model-panel-formula"),u=f.data("editor"),r=u.getDoc();r.replaceRange((n.data.alias||t()._model.alias)+"."+n.data.column,r.getCursor("from"),r.getCursor("to"));u.focus();i.stopPropagation()}}).on("drop",".cloud-model-table",function(){n&&n.type=="column"&&(n.data.rollback=null,n.data.commit&&n.data.commit())}).on("drop",".cloud-model-list td",function(i){if(n&&n.type=="field"){var r=$(i.target).parent(),e=i.originalEvent.pageY,u=n.data,f=r.attr("data-field"),o=r.offset().top+r.outerHeight()/2;if(w(u))return!1;setTimeout(function(){e<o?t().moveFieldBefore(u,f):t().moveFieldAfter(u,f)},50);i.preventDefault()}}).on("drop",".cloud-model-list",function(){if(n&&n.type=="column"){var i=t(),r=n.data.alias||i._model.alias,u={newFieldName:r+(r.match(/\_/)?"_":"")+n.data.column,formula:r+"."+i.quotedName(n.data.column)};setTimeout(function(){i.formulaField(u)},100)}}).on("drop",".cloud-model-container",function(i){if(n&&n.type=="tableName"){var r=$(this),f=r.offset(),u=n.data,e=i.originalEvent,o=t();u.x+=e.pageX-f.left+r.scrollLeft();u.y+=e.pageY-f.top+r.scrollTop();o.addTable(u);ut(o._diagram.find(".cloud-model-table").last())}}).on("dragend",function(){n&&(clearTimeout(ct),n.data.rollback&&(n.data.rollback(),n.data.rollback=null),n.data.commit=null,n.data=null,n.element=null,n=null,$(".cloud-model-dragging,.cloud-model-drop-target").removeClass("cloud-model-dragging cloud-model-drop-target"))}).on("getvalue.input.app",".cloud-model-table th",function(n){var r=$(n.target),i=r.closest("[data-table]");n.inputValue=i.is(".cloud-model-table-base")?t()._model.alias:i.attr("data-foreign-key")}).on("setvalue.input.app",".cloud-model-table th",function(n){var i=t().changeTableAlias({newTableAlias:n.inputValue,tableAlias:n.inputOriginalValue});i!=!0&&(n.inputValid=!1,n.inputError=i)}).on("beforefocus.input.app",".cloud-grid [data-column]",function(n){var i=$(n.target),t=i.closest(".cloud-grid"),o=t.find(".cloud-grid-header"),r=i.offset(),u=t.offset(),f=0,e;t.find('.cloud-grid-header [data-column="'+i.attr("data-column")+'"]').addClass("cloud-grid-focus");i.parent().addClass("cloud-grid-focus");r.top<u.top+o.outerHeight()&&t.scrollTop(t.scrollTop()+r.top-(u.top+o.outerHeight()));u.left+t.width()-c.width<r.left+i.outerWidth(!0)?f=r.left+i.outerWidth(!0)-(u.left+t.width()-c.width):r.left<u.left&&(f=r.left-u.left-1);f!=0&&(e=t.find(".cloud-grid-hscrollbar"),e.scrollLeft(e.scrollLeft()+f),e.trigger("scroll"))}).on("getvalue.input.app",".cloud-grid [data-column]",function(n){var i=$(n.target),r=i.attr("data-column"),u=t()._fieldGrid.rows()[i.parent().index()];n.inputValue=u[r]}).on("setvalue.input.app",".cloud-grid [data-column]",function(n){var i=$(n.target),r={name:i.attr("data-column"),value:n.inputValue,fieldName:i.parent().attr("data-field"),textInput:i},u=t().changeFieldProperty(r);u!=!0?(n.inputValid=!1,n.inputError=u):n.inputValidCallback=r.success});f.on("resize",function(i){ni();clearTimeout(ei);setTimeout(function(){try{t().scale();var r=$(".cloud-model-list"),u=$(".cloud-divider-horizontal");(r.outerHeight()<101||f.height()-r.outerHeight()+r.next().outerHeight()<150)&&(n={type:"divider",element:u,data:r.find(".cloud-grid")},u.trigger("mousemove",i).trigger("dragend",i));ui()}catch(e){}},200)});typeof CloudOnTime=="undefined"&&(r.CloudOnTime={});typeof r.CloudOnTime.Models=="undefined"&&(r.CloudOnTime.Models={});typeof r.CloudOnTime.Utilities=="undefined"&&(r.CloudOnTime.Utilities={});$(document).on("click","[data-input]",function(n){fi($(n.target))&&n.preventDefault()}).on("blur",".cloud-model-input",function(n){function o(n,i){setTimeout(function(){t.focus();n&&(t.attr("title",n),ri(t.offset().left+1,t.offset().top+1,n));i&&i(r)},10)}function s(n){setTimeout(function(){t.attr("title")&&modelBuilder_hideTooltip();t.remove();e.remove();h.contents().css("visibility","");n&&n(r);$(".cloud-grid-focus").removeClass("cloud-grid-focus")},10)}var t=$(n.target),r=t.closest("[data-input]"),u=t.data("original"),f=t.val().trim(),e=t.parent(),h=e.parent(),i;$(n.relatedTarget).is(".cloud-model-input-container")?o():f==u?s():(i=$.Event("setvalue.input.app",{inputValue:f,inputOriginalValue:u,inputElement:t.get(0),inputValid:!0,inputError:null}),r.trigger(i),i.inputElement=null,i.inputValid?s(i.inputValidCallback):(n.preventDefault(),o(i.inputError,i.inputErrorCallback)))}).on("keydown",".cloud-model-input",function(n){function f(n){setTimeout(function(){u.blur();n&&setTimeout(function(){var t=$(n),i=t.find("[data-input-hotspot]");fi(i.length?i:t)},10)},10)}function c(n){var t,i,r;return t=o.data("active",!0).parent().find("[data-input-container]"),$(t).each(function(n){var t=$(this);if(t.data("active"))return i=n,t.removeData("active"),!1}),r=n=="up"?i==0?null:$(t.get(i-1)):i<t.length-1?$(t.get(i+1)):null,r?r.find("[data-input]"):null}var t=n.keyCode||n.which,a=n.key,l,h,u=$(n.target),r,o,i,s,e;if(t==27&&(changed=u.val()!=u.data("original"),changed?u.val(u.data("original")):f(),n.preventDefault()),t==13&&n.ctrlKey){f(u.closest("[data-input]"));n.preventDefault();return}if(t==9&&(r=n.shiftKey?"left":"right"),t==37&&this.selectionStart==0&&this.selectionEnd==0&&(r="left"),t==39&&this.selectionStart==this.value.length&&(r="right"),(t==38||t==13&&n.shiftKey)&&(r="up"),t!=40&&(t!=13||n.shiftKey)||(r="down"),r&&u.closest("[data-input]").is('[data-input-tab-stop="false"]')){(t==13||t==9)&&(f(),n.preventDefault());return}r&&(o=u.closest("[data-input-container]"),o.length||(o=rt),u.closest("[data-input]").data("active",!0),s=o.find("[data-input]").each(function(n){var t=$(this);if(t.data("active"))return e=n,t.removeData("active"),!1}),r=="left"?e?f(s.get(e-1)):t==9&&(i=c("up"),i&&i.length&&f(i.get(i.length-1))):r=="right"?e<s.length-1?f(s.get(e+1)):t==9&&(i=c("down"),i&&i.length&&f(i.get(0))):(r=="up"||r=="down")&&(i=c(r),i?f(i.get(i.length>e?e:i.length-1)):r==="down"&&f(u.closest("[data-input]"))),n.preventDefault());t==113&&(l=this.selectionStart,h=this.selectionEnd,l==0&&h==this.value.length?this.selectionStart=h:(this.selectionStart=0,this.selectionEnd=this.value.length),n.preventDefault())});CloudOnTime.Utilities.grid=function(n){this._options=n;n.showRowNumber&&n.columns.splice(0,0,{name:"RowNumber",text:"#",fixed:n.columns[0].fixed,value:function(t){return{text:n.rows.indexOf(t)+1+"."}}})};CloudOnTime.Utilities.grid.prototype={attach:function(){var n=this,r=n._options,f,e,o,s,t=[],i;if(n._grid=$('<div class="cloud-grid"><\/div>').appendTo(r.container).on("mouseenter","tbody tr",function(){var t=$(this).addClass("cloud-grid-hover"),r=t.index(),i;i=t.closest(".cloud-grid-fixed-columns").length?n._tableBody:n._fixedTableBody;i.find("tr:eq("+r+")").addClass("cloud-grid-hover")}).on("mouseleave","tbody tr",function(){n._grid.find(".cloud-grid-hover").removeClass("cloud-grid-hover")}).on("scroll",function(){ot||$(u).hide()}),o=n._header=$('<div class="cloud-grid-header"><\/div>').appendTo(n._grid).css({right:c.width}),n._body=$('<div class="cloud-grid-body"><\/div>').appendTo(n._grid),n._table=f=$('<table class="cloud-grid-table"/>').appendTo(n._body),e=n._headerRow=$("<tr/>").appendTo($("<thead/>").appendTo(f)),n._fixedColumns=t,$(r.columns).each(function(){var n=this;n.fixed&&t.push(n);$("<th/>").appendTo(e).attr("data-column",n.name).html(n.text||n.name)}),s=n._tableBody=$("<tbody/>").appendTo(f),i=$('<table class="cloud-grid-fixed-columns"/>').appendTo(n._body),n._fixedTableBody=$("<tbody/>").appendTo(i),n._renderRows(),$(r.columns).each(function(){var n=this,t=e.find('[data-column="'+n.name+'"]'),i=n.width||t.width()+1;$("<span/>").appendTo(o).attr("data-column",n.name).html(n.text||n.name).attr("title",n.tooltip);s.find('[data-column="'+n.name+'"]')}),t.length){var h=$("<thead/>").appendTo(i),l=n._fixedHeaderRow=$("<tr/>").appendTo(h),h=n._fixedHeader=$('<div class="cloud-grid-header cloud-grid-header-fixed"><\/div>').insertBefore(n._body);$(t).each(function(){var n=this,t=n.width;$("<th/>").appendTo(l).attr("data-column",n.name).html(n.text||n.name).attr("title",n.tooltip)});$(t).each(function(){var n=this,t=n.width;$("<span/>").appendTo(h).attr("data-column",n.name).html(n.text||n.name).attr("title",n.tooltip)})}n._fixedHeader.hide();n._fixedTableBody.parent().hide();n._configureColumnWidth();n._grid.css("margin-bottom",c.height);n._hscrollbar=$('<div class="cloud-grid-hscrollbar"><\/div>').appendTo(n._grid).css({height:c.height+1,right:c.width}).on("scroll",function(){$(u).hide();var t=-n._hscrollbar.scrollLeft(),r=$(i);o.css("margin-left",t);n._body.css("margin-left",t);r.css("margin-left",-t);t==0?r.removeClass("cloud-grid-fixed-shadow"):r.addClass("cloud-grid-fixed-shadow")});n._hscrollable=$("<div><\/div>").appendTo(n._hscrollbar).css({height:c.height});n.hscrollbar()},fit:function(){var n=this,i=n._tableBody.find("tr:first td"),r=n._header.find("[data-column]"),t;$(i).each(function(n){var f=$(this),i=Math.ceil(f.width()),u=$(r[n]),e=u.width();i!=e&&(u.css({"min-width":i,"max-width":i,width:i}),t=!0)});t&&n.hscrollbar()},refresh:function(){var n=this;n._renderRows();n._configureColumnWidth();n.hscrollbar()},hscrollbar:function(){var n=this;n._hscrollable.css("width",n._tableBody.outerWidth())},_configureColumnWidth:function(){var n=this,t=n._options;$(t.columns).each(function(t){var r=this,u=n._headerRow.find('[data-column="'+r.name+'"]'),i=u.css({"min-width":"","max-width":"",width:""}).width()+1;u.width(i);n._header.find('[data-column="'+r.name+'"]').css({"min-width":i,"max-width":i});n._tableBody.find('[data-column="'+r.name+'"]:first').css({"min-width":i,"max-width":i});t<n._fixedColumns.length&&(n._fixedHeader.find('[data-column="'+r.name+'"]').css({"min-width":i,"max-width":i}),n._fixedTableBody.find('[data-column="'+r.name+'"]:first').css({"min-width":i,"max-width":i}))})},_renderRows:function(){function f(n,t,i){i.attr("data-input-container","row");$(n).each(function(){var n=this,r=$("<td/>").appendTo(i).attr("data-column",n.name),u=n.value?n.value(t):t[n.name],e=n.className?n.className(t):null,o=n.readOnly?typeof n.readOnly=="function"?n.readOnly(t):n.readOnly:!1,f;u&&(n.value?r.text(u.text).attr("title",u.tooltip):r.text(u));n.corner&&(f=n.corner(t),f&&$('<span class="cloud-grid-corner"/>').appendTo(r).attr("title",f.text).addClass(f.className));e&&r.addClass(e);n.draggable&&r.attr("draggable","true");n.maxWidth&&r.css("max-width",n.maxWidth);n.minWidth&&r.css("min-width",n.minWidth);o||r.attr({"data-input":"text"})})}var t=this,i=t._grid,e=i.scrollTop(),n=t._options,r=t._tableBody,u=t._fixedTableBody,o=t._fixedColumns;r.find("tr").remove();u.find("tr").remove();i.find("[data-column]").css({"min-width":"","max-width":""});$(n.rows).each(function(t){var i=this,u=$("<tr/>").appendTo(r);n.setupRow&&n.setupRow(u,i);f(n.columns,i,u,t)});$(n.rows).each(function(t){var i=this,r=$("<tr/>").appendTo(u);n.setupRow&&n.setupRow(r,i);f(o,i,r,t)});i.scrollTop(e)},detach:function(){},findRowIndex:function(n){var i=this,t=-1;return $(i._options.rows).each(function(i){var f=this,r,u=!0;for(r in n)if(f[r]!=n[r]){u=!1;break}if(u)return t=i,!1}),t},rows:function(){return this._options.rows},findRow:function(n){var t=this.findRowIndex(n);return this.rows()[t]},column:function(n){var t;return $(this._options.columns).each(function(){if(this.name==n)return t=this,!1}),t}};CloudOnTime.Models.builder=function(n){var t=this,i=n.model.dataModel,f=n.database,r=[],u;t._options=n;t._model=i;t._database=f;t._masterDetail=n.masterDetail;u=[];$(i.columns).each(function(){var n=this;n.primaryKey&&u.push(n.name)});$(t._database.dataModel).each(function(){this.schema||(this.schema="")});t._right=0;t._scaleRatio=1;t._bottom=0;t.setupMappings();t._modelMap={};t._columnMap={};$(f.dataModel).each(function(){var n=this,f={},e={};n.primaryKey||(n.primaryKey=[]);n.primaryKey.length||n.schema!=i.baseSchema||n.name!=i.baseTable||$(u).each(function(){n.primaryKey.push({_type:"primaryKeyColumn",columnName:this,isVirtual:!0})});$(n.primaryKey).each(function(){f[this.columnName]=this});$(n.foreignKeys).each(function(n){var t=this;$(this.foreignKey).each(function(){e[this.columnName]={index:n,info:t}})});t._modelMap[n.schema+"_"+n.name]={tableModel:n,primaryKey:f,foreignKeys:e};$(n.columns).each(function(){var i=this;t._columnMap[n.schema+"_"+n.name+"_"+i.name]=i});r.indexOf(n.schema)===-1&&r.push(n.schema);t._schemas=r})};CloudOnTime.Models.builder.prototype={model:function(){return this._options.model.dataModel},hosted:function(){return this._options.hosted},setupMappings:function(){var n=this,t=n._options.model.dataModel;n._fieldMap={};$(t.columns).each(function(){n._fieldMap[(this.foreignKey||n._model.alias)+"_"+this.name]=this});n._foreignKeyMap={};n._aliasMap={};n._aliasedMap={};$(t.foreignKeys).each(function(){n._foreignKeyMap[this.id]=this});$(t.columns).each(function(){this.aliasColumnName&&(n._aliasedMap[(this.aliasForeignKey||t.alias)+"_"+this.aliasColumnName]=this,n._aliasMap[(this.aliasForeignKey||t.alias)+"_"+this.aliasColumnName]=n._fieldMap[(this.aliasForeignKey||t.alias)+"_"+this.aliasColumnName])})},finalDataModel:function(){function c(n){var i;return e[n.id]?i=!0:$(t).each(function(){var t=this;t.baseForeignKey==n.id&&c(t)&&(i=!0)}),i}function y(n,t){var u=n.offset(),i,r;t.x=i=Math.ceil((u.left-p)/l);t.y=r=Math.ceil((u.top-w)/l);i<f&&(f=i);r<o&&(o=r)}var r=this,n=r.model(),t,e,u;for(eval("model="+JSON.stringify(n)),t=n.foreignKeys,e={},$(n.columns).each(function(){var n=this;e[n.foreignKey]=!0}),u=0;u<t.length;)c(t[u])?u++:t.splice(u,1);var l=r._scaleRatio,f=1e5,o=f,s,h,a=r._diagram.offset(),v=r._diagram.parent(),p=a.left+v.scrollLeft(),w=a.top+v.scrollTop();return y(r._diagram.find(".cloud-model-table-base"),n),$(t).each(function(){var n=this;y(r._diagram.find('[data-foreign-key="'+n.id+'"]'),n)}),s=i-f,h=i-o,n.x+=s,n.y+=h,$(t).each(function(){var n=this;n.x+=s;n.y+=h}),n},scrollFieldIntoView:function(n){var t=this,u,f,e,i,r,o;u=t._fieldGrid.findRowIndex(n.fieldName?{FieldName:n.fieldName}:{TableAlias:n.tableAlias,TableName:n.tableName,ColumnName:n.columnName});u!=-1&&(t._fieldGrid._fixedTableBody.find("tr:eq("+u+")").addClass("cloud-model-dependency"),f=t._fieldGrid._tableBody.find("tr:eq("+u+")").addClass("cloud-model-dependency"),i=t._fieldGrid._grid,e=f.offset(),o=t._fieldGrid._header.outerHeight(),r=i.offset(),r.top+=o,scrollableHeight=i.height()-o,(e.top<r.top||e.top+f.outerHeight()>r.top+scrollableHeight)&&(ot=!0,i.animate({scrollTop:i.scrollTop()+e.top-r.top-(scrollableHeight-f.outerHeight())/2},300,function(){setTimeout(function(){ot=!1},200)})))},findDiagramColumn:function(n,t){return this._diagram.find(n?'[data-foreign-key="'+n+'"]':".cloud-model-table-base").find('[data-column="'+t+'"]')},clearnIdentifier:function(n){var t=n.replace(/[^\w]/g,"");return(!t.length||t.match(/^\d/))&&(t="n"+t),t},validateFieldName:function(n,t){var i=!0,r=this._model.details;return n?(n=n.toLowerCase(),!n.match(/^[a-z]/i))?"The name must begin with a letter.":n.match(/^([a-z0-9_])+$/i)?n.length>this._database.nameMaxLength?"The name is too long.":(t?$(t).each(function(n){t[n]=this.toLowerCase()}):t=[],$(this._model.columns).each(function(){var r=this.fieldName;if(t.indexOf(r.toLowerCase())===-1&&r.toLowerCase()===n)return i="Duplicate field name.",!1}),r&&r.every(function(r){var u=r.fieldName;return t.indexOf(u.toLowerCase())===-1&&u.toLowerCase()===n&&(i="Duplicate field name."),i===!0}),i):"Only alpha-numeric characters and '_' are allowed.":"A field name is required."},nameToParts:function(n,t){n=n.match(/_/)?n.replace(/(_+)/g," $1"):n.replace(/([A-Z]+)/g," $1");n=n.replace(/([0-9]+)/g," $1");$(n.split(/\s+/)).each(function(){var n=this.toString();n&&(n=n.replace(/\_+/,""),n.length>2&&(n=n.substring(0,1).toUpperCase()+n.substring(1).toLowerCase()),t.length&&t[t.length-1]==n||t.push(n))})},fieldNameToLabel:function(n){var t=[];return this.nameToParts(n,t),t.join(" ")},forEachField:function(n,t){var i=this,r=i._foreignKeyMap[n],u=r?i.findTableModel(r.parentTableSchema,r.parentTableName):i.findTableModel(i._model.baseSchema,i._model.baseTable);$(u.columns).each(function(){var f=this,r={columnName:f.name,tableAlias:n,tableName:u.name,schema:u.schema,silent:!0};t=="add"?i.addField(r):i.removeField(r)});n&&i.reAssignAliasColumn(n);i._fieldGrid.refresh();i.updateStateOfConnectors()},addField:function(n){function d(n){var i=!0;return n.foreignKey.length||(i=!1),n.baseForeignKey&&$(t._model.foreignKeys).each(function(){var t=this;t.id!=n.baseForeignKey||d(t)||(i=!1)}),i}function nt(n){var t=[];return $(n.replace(/([A-Z0-9_]+)/g," $1").split(/\s+/g)).each(function(){var n=this,i=n.match(/[^aeiouy]/i),r=i&&i.index>0?n.substring(0,i.index):"",u=i&&i.index>0?n.substring(i.index):n;n&&n.length&&t.push(r+u.replace(/[aeiouy]/gi,""))}),t.join("")}var t=this,c=t._fieldGrid,l=c.rows(),a=t.findColumnModel(n.schema,n.tableName,n.columnName),it=t.findTableModel(n.schema,n.tableName),g=s(n.schema,n.tableName),u=t.findDiagramColumn(n.tableAlias,n.columnName),b,i=n.tableAlias||"",v=[],y=0,p,k=t._database.nameMaxLength,e,r,f,o,h,w;if(n.tableAlias&&!d(t._foreignKeyMap[n.tableAlias]))return u.find(":input").prop("checked",!1),!1;if(u.is(".cloud-model-column-selected"))return!1;for(i=i?i.match(/[a-z0-9]$/)&&n.columnName.match(/^[A-Z]/)?i+n.columnName:i+"_"+n.columnName:n.columnName,t.nameToParts(i,v),i=v.join(""),p=v.join(" "),i.length>k&&(i=nt(i)),i=t.clearnIdentifier(i);t.validateFieldName(i,null,!0)!=!0;)w=t.clearnIdentifier(n.columnName),i=(w.length<k-1?w:"Field")+(y?y:""),y++;return e={_type:"column",name:n.columnName,fieldName:i,label:p,foreignKey:n.tableAlias},o=vt(a),o&&(e.format=o),r={FieldName:i,AliasFieldName:null,TableAlias:n.tableAlias||t._model.alias,TableName:g,ColumnName:n.columnName,Label:p,Type:tt(a),Format:o,_tableName:n.tableName,_schema:n.schema,_type:a.dataType},t._model.alias!=r.TableAlias&&$(l).each(function(n){this.TableAlias==r.TableAlias&&(h=n)}),h!=null?(t._model.columns.splice(h+1,0,e),l.splice(h+1,0,r)):(t._model.columns.push(e),l.push(r)),t.reAssignAliasColumn(n.tableAlias),t.setupMappings(),n.silent||(c.refresh(),at(i,c)),f=t.columnSpec(r._schema,r._tableName,n.columnName,n.tableAlias),b=u.find(".cloud-model-column-name").attr("title",f.nameTooltip).data("title",f.nameTooltip),clearTimeout(kt),u.find(".cloud-model-column-spec").attr("title",f.tooltip).text(f.text),u.addClass("cloud-model-column-selected").find(":input").prop("checked",!0),n.silent||(kt=setTimeout(function(){b.trigger("mouseenter",200)},50),t.updateStateOfConnectors()),!0},removeField:function(n){var t=this,h=t._fieldGrid,e=t.findDiagramColumn(n.tableAlias,n.columnName),r,o,c=h.rows(),u,f,i,s;f=h.findRowIndex(n.fieldName?{FieldName:n.fieldName}:{ColumnName:n.columnName,_schema:n.schema,_tableName:n.tableName,TableAlias:n.tableAlias||t._model.alias});f>=0&&(i=c[f],$(c).each(function(){this.AliasFieldName==i.FieldName&&(this.AliasFieldName=null)}),$(t._model.columns).each(function(){var n=this;n.aliasColumnName==i.ColumnName&&n.aliasForeignKey==i.TableAlias&&(delete n.aliasColumnName,delete n.aliasForeignKey)}),e.find(".cloud-model-column-name").data("title","").attr("title",null),c.splice(f,1),t._model.columns.splice(f,1),s=t.reAssignAliasColumn(i.TableAlias),t.setupMappings(),i.TableAlias&&(u=t.columnSpec(i._schema,i._tableName,i.ColumnName,i.TableAlias),e.find(".cloud-model-column-spec").text(u.text).attr("title",u.tooltip),e.removeClass("cloud-model-column-selected").find(":input").prop("checked",!1)),s&&(u=t.columnSpec(i._schema,i._tableName,s,i.TableAlias),t.findDiagramColumn(n.tableAlias,s).find(".cloud-model-column-spec").text(u.text).attr("title",u.tooltip)),n.silent||(h.refresh(),r=e.closest(".cloud-model-table"),r.find(".cloud-model-column-selected").length||(o=r.attr("data-foreign-key"),$(t._model.foreignKeys).each(function(){var n=this;n.baseForeignKey==o&&(r=null)}),r&&setTimeout(function(){r.addClass("cloud-model-inspected");confirm('Delete "'+o+'"?')?t.removeTable(o):r.removeClass("cloud-model-inspected")},500))));n.silent||t.updateStateOfConnectors()},moveFieldBefore:function(n,t){this._moveField(n,t,0)},moveFieldAfter:function(n,t){this._moveField(n,t,1)},_moveField:function(n,t,i){var s=this,r=s._fieldGrid,f=r.rows(),e=s._model.columns,u,o,h,c;u=r.findRowIndex({FieldName:n});h=f[u];f.splice(u,1);c=e[u];e.splice(u,1);o=r.findRowIndex({FieldName:t});f.splice(o+i,0,h);e.splice(o+i,0,c);r.refresh();at(n,r);modelBuilder_pauseMouseEvents()},reAssignAliasColumn:function(n){var c=this,t=c._model,a=t.alias,u=c._foreignKeyMap[n],i=c._fieldGrid.rows(),l=[],f=[],v,r=[],e=[],o,y,s,h;if(n!==a&&u&&!u.baseForeignKey&&u.type!=="1-to-1")return($(u.foreignKey).each(function(){l.push(this.columnName)}),$(i).each(function(){var t=this;t.TableAlias==a&&l.indexOf(t.ColumnName)!=-1&&(f.push(t),t.AliasFieldName&&(v=t.AliasFieldName));t.TableAlias==n&&(r.push(t.FieldName),e.push(t))}),!l.length||!r.length||r.lastIndexOf(v)!=-1||!f.length)?void 0:(f[0].AliasFieldName=r[0],s=i.indexOf(f[0]),o=t.columns[s],o.aliasColumnName=e[0].ColumnName,o.aliasForeignKey=n,r.length==1&&(h=i.indexOf(e[0]),y=t.columns[h],i.splice(h,1),t.columns.splice(h,1),i.splice(s+1,0,e[0]),t.columns.splice(s+1,0,y)),o.aliasColumnName)},updateStateOfConnectors:function(){function i(r){var u,f=t.find('[data-foreign-key="'+r+'"]'),o=t.find('[data-connector="'+r+'"]'),e=f.find(":input:checked").length;return e?u=!0:$(n._model.foreignKeys).each(function(){var n=this;n.baseForeignKey==r&&i(n.id)&&(u=!0)}),e?f.removeClass("cloud-model-table-disabled"):f.addClass("cloud-model-table-disabled"),$(o).each(function(){u?yt(this,"cloud-model-connector-disabled"):it(this,"cloud-model-connector-disabled")}),u}var n=this,t=n._diagram;$(n._model.foreignKeys).each(function(){i(this.id)})},attach:function(n){function nt(){f=n.offset();f.left<a&&a<f.left+n.width()&&f.top<y&&y<f.top+n.height()&&$(n).find("[data-table][data-foreign-key]").each(function(){var n=$(this),t=n.offset();if(t.left<=o&&t.top<=e&&o<t.left+n.outerWidth()&&e<t.top+n.outerHeight())return n.trigger("mousemove"),!1})}var t,f,a,y,r,c,p,w,k,l,d,g;$(n).addClass("cloud-model-container").attr({tabindex:1,"data-input-container":"diagram"});t=this;$(n).on("scroll",function(){v();n.find('[title=""]').trigger("mouseleave");$(u).hide();a=o;y=e;clearTimeout(gt);gt=setTimeout(nt,300)});t._diagram=$('<div class="cloud-model-diagram"><\/div>').appendTo(n).data("builder",t);r=this._model;r.x==null&&(r.x=i);r.y==null&&(r.y=i);c=t.renderBaseTable();this._right=r.x+c.outerWidth()+h;this._autoRight=i+c.outerWidth()+h;this._bottom=r.y+c.outerHeight()+h;this.renderMasterTables(null);this._right+=-h+i;t._diagram.width(t._right).height(t._bottom);p=b({type:"svg",width:this._right,height:this._bottom,children:[{type:"defs",children:[{type:"marker",id:"arrow",markerWidth:13,markerHeight:13,refX:12,refY:6,orient:"auto",children:[{type:"path",d:"M2,2 L2,11 L10,6 L2,2",style:"fill: black"}]}]}]});t._diagram[0].appendChild(p);t._canvas=p;$(t._model.foreignKeys).each(function(){t.connector(this,!0)});t.updateConnectors();w=t._list=$('<div class="cloud-model-list"><\/div>').insertBefore(n).data("builder",t);k={container:w,showRowNumber:!1,setupRow:function(n,t){n.attr("data-field",t.FieldName)},columns:[{name:"FieldName",text:"Field",fixed:!0,draggable:!0,tooltip:"Provides an identifier for the corresponding table column in the output of SELECT statement.",className:function(n){var r="",i;return n.TableAlias===t._model.alias&&t.findTableModel(n._schema,n._tableName).primaryKey?(i=t._diagram.find('.cloud-model-table-base [data-column="'+n.ColumnName+'"]'),i.is(".cloud-model-column-pk")&&(r+="cloud-model-list-field-pk"),i.is(".cloud-model-column-required")&&(r+=" cloud-model-list-field-required")):(t._foreignKeyMap[n.TableAlias]||{}).type==="1-to-1"&&(i=t._diagram.find('.cloud-model-table[data-table="'+n._tableName+'"][data-schema="'+n._schema+'"] [data-column="'+n.ColumnName+'"]'),i.is(".cloud-model-column-required")&&(r+=" cloud-model-list-field-required")),r},corner2:function(n){var i,r,u=t._aliasedMap[n.TableAlias+"_"+n.ColumnName];return(n.TableAlias!==t._model.alias&&(i='The value of this field is borrowed from "'+n.TableAlias+'".',r="cloud-grid-corner-borrowed"),u&&(i+=' It provides a user-friendly alias for "'+u.fieldName+'" field.',r="cloud-grid-corner-alias"),i)?(i+=" Borrowed fields are read-only.",{text:i,className:r}):null}},{name:"Type",text:"Data Type",readOnly:!0,tooltip:"Specifies the physical data type of the table column."},{name:"Spec",text:"Spec",readOnly:!0,tooltip:"Provides an abbreviated specification of the data processing properties of the field.",value:function(n){var i="",r="",s,u=n.TableAlias,f=n.ColumnName,h=t._aliasedMap[u+"_"+f],c,e,o=t._diagram.find('.cloud-model-table-base [data-column="'+f+'"] td:first');return o.length&&(i+=o.text(),r+=o.attr("title")||""),!r&&u&&(r="Table\t"+n.TableName+"\nColumn\t"+f),u==t._model.alias?(c=t.findTableModel(n._schema,n._tableName),c.primaryKey&&(e=t.findColumnModel(n._schema,n._tableName,f),e.readOnly||(i&&(i+=", "),i+="W",r+="\nW\tThis field is writeable. Its value will be persisted to the table column in the row matched with the primary key."))):(t._foreignKeyMap[n.TableAlias]||{}).type==="1-to-1"&&(e=t.findColumnModel(n._schema,n._tableName,f),e.readOnly||(s=!0,i&&(i+=", "),i+="W",r+="\nW\tThis field is writeable. Its value will be persisted to the table column in the row matched with the primary key.")),!u&&n.SqlFormula?(i&&(i+=", "),i+="F",r&&(r+="\n"),r+="F\tThe read-only value of this field is a computed SQL formula."):u!=t._model.alias&&(i&&(i+=", "),i+="B",r&&(r+="\n"),r+="B\tThe "+(s?"":"read-only ")+'value of this field is borrowed from "'+u+'".'),!h||i&&i.match(/\bA\b/)||(i&&(i+=", "),i+="A",r&&(r+="\n"),r+='A\tProvides a user-friendly alias for "'+h.fieldName+'" field.'),i||r?{text:i,tooltip:r}:null}},{name:"Label",text:"Label",tooltip:"Defines a user-friendly label assigned to the field."},{name:"Format",text:"Format",tooltip:"Defines a data format string for the field value."},{name:"SortType",text:"Sort Type",tooltip:"Defines an optional ascending or descending sort type for the field.",minWidth:80},{name:"SortOrder",text:"Sort Order",tooltip:"Defines a position of the field in an optional sort expression."},{name:"AliasFieldName",text:"Alias",tooltip:"Defines an alternative field that will have its value presented to a user instead of the physical field value.",minWidth:80},{name:"SqlFormula",text:"SQL Formula",maxWidth:300,readOnly:function(){return!0},tooltip:"Defines an optional SQL expression that will be evaluated by the database engine to produce a field value."},{name:"TableAlias",text:"Table Alias",readOnly:!0,tooltip:"Specifies the alias name of the database table in the SELECT statement that contains the base column of the field."},{name:"TableName",text:"Table Name",readOnly:!0,tooltip:"Specifies the name of the database table that contains the base column of the field."},{name:"ColumnName",text:"Column",readOnly:!0,tooltip:"Specifies the name of the column in the database table that provides the field value."}],rows:[]};$(r.columns).each(function(){var n=this,h=n.fieldName||n.name,f=n.aliasColumnName?t._aliasMap[(n.aliasForeignKey||r.alias)+"_"+n.aliasColumnName]:null,c=f&&(f.fieldName||f.name),i=t._foreignKeyMap[n.foreignKey],l=i?s(i.parentTableSchema,i.parentTableName):s(r.baseSchema,r.baseTable),v=i?i.id:r.alias,y=(i?i.id:r.alias)+" ("+l+")",e=i?i.parentTableName:r.baseTable,o=i?i.parentTableSchema:r.baseSchema,p=t.findTableModel(o,e),u,a=t.findColumnModel(o,e,n.name);u=a?{FieldName:h,AliasFieldName:c,TableAlias:v,TableName:l,ColumnName:n.name,Type:tt(a),_tableName:e,_schema:o}:{FieldName:h,AliasFieldName:c,Type:n.type,SqlFormula:n.formula};u.Label=n.label;n.format&&(u.Format=n.format);n.sortOrder&&(u.SortOrder=n.sortOrder);n.sortType&&(u.SortType=n.sortType);k.rows.push(u)});l=new CloudOnTime.Utilities.grid(k);t._fieldGrid=l;l.attach();l._grid.attr("tabindex",1);d=w.outerHeight(!0);g=$('<div class="cloud-divider-horizontal"><\/div>').insertBefore(n).css("top",d);n.css("top",d+g.outerHeight(!0));t.masterDetail(t._masterDetail)},connector:function(n,t){var i=this,r=i._diagram.find('[data-connector="'+n.id+'"]');$(n.foreignKey).each(function(){var f=this,u=n.baseForeignKey?i._foreignKeyMap[n.baseForeignKey]:null,e=u?u.parentTableSchema:i._model.baseSchema,o=u?u.parentTableName:i._model.baseTable;t?r.length||b({type:"path",parent:i._canvas,"data-connector":n.id,"data-parent-column":f.parentColumnName,"class":"cloud-model-connector","marker-end":"url(#arrow)",title:"Child Table\t"+s(e,o)+"\nChild Column\t"+f.columnName+"\nParent Table\t"+s(n.parentTableSchema,n.parentTableName)+"\nParent Column\t"+f.parentColumnName+"\n"}):r.remove()})},scale:function(n){var t=this,o=t._diagram;if(typeof n=="boolean")o.css("transform",n?"scale("+t._scaleRatio+")":"");else{var r=$(".cloud-model-panel-masterdetail"),u=f.width()-(r.is(":visible")?r.outerWidth(!0):0),e=t._right;n?t._scale=n:n=t._scale||"Auto Scale";!n||n==="100%"||n==="Auto Scale"&&u>e?(t._scaleRatio=1,t.scale(!1)):(n=n!=="Fit Width"&&n!=="Auto Scale"&&n?parseInt(n.toString())/100:(u-i)/e,t._scaleRatio=n,t.scale(!0))}},updateConnectors:function(t){function i(n){return Math.ceil(n)}function f(){r.scale(!1);$(u).each(function(){b(this)});r.scale(!0)}var r=this,u=[];$(r._model.foreignKeys).each(function(){var v=this,e=v.id,o=v.baseForeignKey;if(!t||t.indexOf(o||"")>=0||t.indexOf(e)>=0){var f=n&&n.data.connectors,s=r._diagram,h,c,l,a=s.offset().left,y=s.scrollTop()-s.offset().top;n&&!f&&(f=n.data.connectors={parentTables:{},parentTableColumns:{},childTables:{},childTableColumns:{},lines:{}});n&&(h=f.parentTables[e],c=f.childTables[o||"__base"],n.type!="column"&&(l=f.lines[e]));h||(h=s.find('.cloud-model-table[data-foreign-key="'+e+'"]'),f&&(f.parentTables[e]=h,f.parentTableColumns[e]={}));c||(c=s.find(o?'.cloud-model-table[data-foreign-key="'+o+'"]':".cloud-model-table-base"),f&&(f.childTables[o||"__base"]=c,f.childTableColumns[o||"__base"]={}));l||(l=s.find('[data-connector="'+e+'"]'),f&&(f.lines[e]=l));$(v.foreignKey).each(function(n){var s=this,tt=l.get(n),t=f?f.childTableColumns[o||"__base"][s.columnName]:null,v,r=f?f.parentTableColumns[e][s.parentColumnName]:null,p,w,b,k,d,g,nt;t||(t=c.find('[data-column="'+s.columnName+'"]'),f&&(f.childTableColumns[o||"__base"][s.columnName]=t));v=t.offset();r||(r=h.find('[data-column="'+s.parentColumnName+'"]'),f&&(f.parentTableColumns[e][s.parentColumnName]=r));p=r.offset();w=v.left+t.outerWidth()/2<p.left?{start:"right",end:"left"}:p.left+r.outerWidth()/2<v.left?{start:"left",end:"right"}:{start:"left",end:"left"};b=w.start=="right"?v.left+t.outerWidth()-a:v.left-1-a;k=v.top+y+t.outerHeight()/2;d=w.end=="left"?p.left-1-a:p.left+r.outerWidth()-a;g=p.top+y+r.outerHeight()/2;nt="M"+i(b)+","+i(k)+" L"+i(b+(w.start=="right"?8:-8))+","+i(k)+" L"+i(d+(w.end=="left"?-20:20))+","+i(g)+" L"+i(d)+","+i(g);u.push({element:tt,d:nt})})}});n&&n.type=="column"?f():requestAnimationFrame(f);t||r.updateStateOfConnectors()},columnSpec:function(n,t,i,r){var e=this,f="",u="",y,p=e._modelMap[n+"_"+t],d=p.primaryKey,g=p.foreignKeys,o,w,h,c,l,b,k,a=d[i],v;return a&&(f=a.isVirtual?"VPK":"PK",u=a.isVirtual?"VPK\tDefines the virtual primary key.":"PK\tDefines the primary key.",b=!0),o=g[i],o&&(k=!0,f.length&&(f+=", "),fktext="FK"+(o.index+1),f+=fktext,u&&(u+="\n"),$(o.info.foreignKey).each(function(){if(this.columnName==i)return w=this.parentColumnName,!1}),u+=fktext+'\tDefines the foreign key referencing "'+w+'" column of "'+s(o.info.parentTableSchema,o.info.parentTableName)+'" table.\n'),h=e._aliasedMap[r+"_"+i],h&&(f.length&&(f+=", "),f+="A",u&&(u+="\n"),u+="A\tProvides a user-friendly alias for ",v=e._foreignKeyMap[h.aliasForeignKey],v?(l=v.foreignKey,$(l).each(function(n){n>0&&(u+=n==l.length-1?" and ":", ");u+='"'+this.columnName+'"'}),u+=" column"+(l.length>1?"s":""),u+=' of "'+(h.foreignKey||e._model.alias)+'".\n'):u+='"'+h.fieldName+'" field.'),c=e._fieldMap[(r||e._model.alias)+"_"+i],c&&(y="Table\t"+s(n,t)+"\nColumn\t"+i+"\nField\t"+(c.fieldName||c.name)),f&&(u="Table\t"+s(n,t)+"\nColumn\t"+i+"\n"+u),{text:f,tooltip:u,pk:b,fk:k,nameTooltip:y}},renderBaseTable:function(){var t=this,n=t._model,u=t.findTableModel(n.baseSchema,n.baseTable),i=t._diagram.find(".cloud-model-table-base"),r=i.length?i:t.renderTable(u,n.alias,!0);return r.css({left:n.x,top:n.y}),r},renderMasterTables:function(n){var t=this,f=[],u=t._autoRight,r=i;$(t._model.foreignKeys).each(function(){var e=this,s,o,c,l;this.baseForeignKey==n&&(r>1e3&&(r=i,u=t._autoRight+h),s=t._diagram.find('[data-foreign-key="'+e.id+'"]'),o=s.length?s:t.renderTable(t.findTableModel(e.parentTableSchema,e.parentTableName),e.id),e.x==null?e.x=u:u=e.x,e.y!=null&&(r=e.y),o.css({left:u,top:r}).attr("data-foreign-key",e.id),r+=o.outerHeight()+h,c=u+o.outerWidth()+h,c>t._right&&(t._right=c),l=r,t._autoRight=Math.max(t._autoRight,u+o.outerWidth()+h),t._bottom=Math.max(t._bottom,r-h+i),f.push(this.id))});$(f).each(function(){t.renderMasterTables(this)})},findTableModelInfo:function(n,t){return this._modelMap[n+"_"+t]},findTableModel:function(n,t){return this.findTableModelInfo(n,t).tableModel},findColumnModel:function(n,t,i){return this._columnMap[n+"_"+t+"_"+i]},renderTable:function(n,t,i){function c(r){var f=$('<tr class="cloud-model-column"/>').appendTo(u).attr("data-column",r.name),o,s=e.columnSpec(n.schema,n.name,r.name,t),h,c,l;return o=$('<td class="cloud-model-column-spec"/>').appendTo(f),s.pk&&f.addClass("cloud-model-column-pk"),s.fk&&f.addClass("cloud-model-column-fk"),s.text&&(o.text(s.text),o.attr("title",s.tooltip)),o=$('<td class="cloud-model-column-name" draggable="true"/>').appendTo(f),h=e._fieldMap[(i?e._model.alias:t)+"_"+r.name]!=null,c=$('<input type="checkbox" />').appendTo(o),h&&(f.addClass("cloud-model-column-selected"),c.prop("checked",!0)),$("<span/>").appendTo(o).text(r.name),s.nameTooltip&&o.attr("title",s.nameTooltip),l=tt(r),$('<td  class="cloud-model-column-type"/>').appendTo(f).text(l),r.allowNulls==!1&&f.addClass("cloud-model-column-required"),$(u),f}var e=this,r,u=$('<table class="cloud-model-table"><\/table>').appendTo(this._diagram).attr({"data-table":n.name,"data-schema":n.schema}),h=e.findTableModelInfo(n.schema,n.name).primaryKey,l=[],a=[],f,o;return r=n.schema,r=="dbo"?r="":r&&(r+="."),r+=n.name,f=$('<th colspan="3" data-input="text" data-input-tab-stop="false"/>').appendTo($("<tr/>").appendTo(u)),o=$('<span data-input-hotspot="true"/>').appendTo(f).text(r),t&&t!=r&&(f.css("maxWidth",f.width()*1.1),r=t+" ("+r+")",o.text(r)),i&&u.addClass("cloud-model-table-base"),f.attr({title:"Table:\t"+s(n.schema,n.name)+(t?"\nAlias:\t"+t:"")}),$(n.columns).each(function(){h[this.name]&&l.push(c(this))}),n.primaryKey&&n.primaryKey.length&&n.primaryKey.length<n.columns.length&&$('<tr class="cloud-model-column-separator"><td colspan="3"/><\/tr>').appendTo(u),$(n.columns).each(function(){h[this.name]||a.push(c(this))}),ut(u,!0),u},arrange:function(){var n=this,t=n._model,u=n._diagram,r=u.find(".cloud-model-table-base");n.scale(!1);r.css({left:i,top:i});n._autoRight=n._right=i+r.outerWidth()+h;n._bottom=i+r.outerHeight();t.x=i;t.y=i;$(t.foreignKeys).each(function(){var n=this;n.x=null;n.y=null});n.renderMasterTables();n.updateConnectors();n.scale(!0);u.parent().scrollLeft(0).scrollTop(0)},findTableElement:function(n){return this._diagram.find(n.name?'.cloud-model-table[data-schema="'+n.schema+'"][data-table="'+n.name+'"]':'[data-foreign-key="'+n.foreignKey+'"]')},quotedName:function(n){if(n.match(/\s/)){var t=this._database.quote;n=t+n+t}return n},field:function(n){n=n.toLowerCase();var i=this,t={row:null,column:null,index:-1};return $(i._model.columns).each(function(r){var u=this;if(u.fieldName.toLowerCase()==n)return t.index=r,t.column=u,t.row=i._fieldGrid.rows()[r],!1}),t},whereClause:function(n){var t=this;if(arguments.length)n?t.formulaField({fieldName:"_where_clause_",formula:t._model.where}):t.formulaField(!1);else return!!t._model.where},formulaField:function(n){function s(){return i.find(".cloud-model-formula-field :text")}function c(){return i.data("editor")}function v(){var n=i.data("options"),t=n&&n.fieldName;return t&&t=="_where_clause_"}function p(){var n=!0,e=s(),l=e.val().trim(),u=c(),o=u.getDoc().getValue(),f=i.data("options"),h=t.validateFieldName(l,f&&f.fieldName?[f.fieldName]:null);return h!=!0?(alert(h),n=!1,e.focus()):o||(n=!1,alert("SQL forumula cannot be blank."),u.focus()),n==!0&&(t.hosted()?(r=window.external.ValidateFormula(o),r.match(/^success,/)?(n=!0,r=r.split(/,/g)):(alert(r),u.focus(),n=!1)):r=["success","Decimal*","money*"]),n}var t=this,l=t._list,a=l.find(".cloud-grid"),i=l.find(".cloud-model-panel-formula"),y,r,f,u={},e,o,w;if(!arguments.length)return i.length>0&&i.is(":visible");if(typeof n=="boolean"||n.newFieldName||n.fieldName){if(!i.length){if(n===!1)return;i=$('<div class="cloud-model-panel cloud-model-panel-formula"><\/div>').appendTo(l).height(a.outerHeight(!0)).on("click",".cloud-model-formula-cancel",function(){t.formulaField(!1)}).on("click",".cloud-model-formula-verify",function(){p()==!0&&(alert("Success."),f.focus())}).on("click",".cloud-model-formula-save",function(){var b;if(v()){var o=c(),u=o.getDoc().getValue().trim(),g=u,k=new RegExp(t._database.parameterMarker+"([\\w\\d\\_]+?)\\b","g"),e,w=[];if(u){if(e=k.exec(u),e){while(e)w.indexOf(e[0])==-1&&w.push(e[0]),e=k.exec(u);$(w).each(function(){var n=this,t=new RegExp("\\n-- "+n+" = .+(\\n|$)");u.match(t)||(u.match(/\n-- .+$/)||(u+="\n"),u+="\n-- "+n+" = null")})}u!=g?(alert("Please define parameter values by editing the values in the comment."),o.getDoc().setValue(u),o.focus()):(b=!t.hosted()||window.external.ValidateWhereClause(u),b==!0?(t._model.where=u,t.formulaField(!1)):(alert(b),o.focus()))}else delete t._model.where,t.formulaField(!1)}else if(p()==!0){var d=t._fieldGrid,nt=d.rows(),f=s().val().trim(),h=t.fieldNameToLabel(f),l=c().getDoc().getValue(),n,a=i.data("options"),y=vt({name:f,type:r[2],dataType:r[1]});a.fieldName?(n=t.field(a.fieldName),vt({name:a.fieldName,type:n.column.type,dataType:n.column.dataType})==n.column.format&&(n.column.format=y,n.row.Format=y),n.column.fieldName=f,n.column.formula=l,n.column.dataType=r[1],n.column.type=r[2],n.row.FieldName=f,n.row.SqlFormula=l,n.row.DataType=r[1],n.row.Type=r[2],t.fieldNameToLabel(a.fieldName)==n.row.Label&&(n.column.label=h,n.row.Label=h)):(nt.push({FieldName:f,Label:h,Type:r[2],DataType:r[1],SqlFormula:l,Format:y}),t._model.columns.push({_type:"column",fieldName:f,formula:l,type:r[2],dataType:r[1],label:h,format:y}));d.refresh();t.formulaField(!1);modelBuilder_showFieldOnDiagram(f)}});$('<div class="cloud-model-formula-field"><input type="text"/><\/div>').appendTo(i).find(":text");y=$('<div class="cloud-model-formula-text"><\/div>').appendTo(i);$('<button class="cloud-model-formula-verify">Verify<\/button>').appendTo(i);$('<button class="cloud-model-formula-save">Save<\/button>').appendTo(i);$('<button class="cloud-model-formula-cancel">Cancel<\/button>').appendTo(i);i.data("hints",u);f=new CodeMirror(y[0],{mode:"text/x-mssql",indentWithTabs:!0,dragDrop:!1,smartIndent:!0,lineNumbers:!0,matchBrackets:!0,autofocus:!1,readOnly:!1,extraKeys:{"Ctrl-Space":"autocomplete"},hint:CodeMirror.hint.sql,hintOptions:{tables:u}});i.data("editor",f)}if(n){t.addTable()&&t.addTable(!1);i.data("options",n);u=i.data("hints");for(w in u)delete u[w];function b(n,i,r){var e=t.findTableModel(n,i),f=[];$(e.columns).each(function(){f.push(this.name)});u[r]=f}function h(n){u[t._database.parameterMarker+n]=[]}if(b(t._model.baseSchema,t._model.baseTable,t._model.alias),$(t._model.foreignKeys).each(function(){var n=this;b(n.parentTableSchema,n.parentTableName,n.id)}),h("BusinessRules_UserId"),h("BusinessRules_UserName"),h("BusinessRules_PROPERTY"),h("Session_VARIABLE"),h("Url_PARAMETER"),a.css("visibility","hidden"),i.show(),e=n&&(n.newFieldName||n.fieldName)||"Field",n&&!n.fieldName){for(o=1;t.validateFieldName(e+o)!=!0&&o<100;)o++;e+=o}s().val(e).data("fieldName",e);v()?(i.addClass("cloud-model-panel-formula-where"),s().val("WHERE").prop("readonly",!0)):(i.removeClass("cloud-model-panel-formula-where"),s().prop("readonly",null).parent());f=c();f.getDoc().setValue(n&&n.formula||"");f.focus()}else a.css("visibility",""),i.hide();t.hosted()&&(v()?(window.external.UIState("WhereClause",n!=!1),window.external.UIState("FormulaField",!1)):(window.external.UIState("FormulaField",n),window.external.UIState("WhereClause",!1)))}},toModelName:function(n){n=this.clearnIdentifier(n);return n},toFieldName:function(n){for(var i=this,r=0,t=n=i.clearnIdentifier(n);i.validateFieldName(t,null,!0)!==!0;)r++,t=n+r.toString();return t},masterDetail:function(n){var t=this,h=t._list,e,i=$(".cloud-model-panel-masterdetail"),c=t._model,o=c.details,r,s,f,u;if(!arguments.length)return i.length&&i.is(":visible");if(typeof n=="boolean"){if(!i.length){if(n===!1)return;i=$('<div class="cloud-model-panel-masterdetail"><\/div>').appendTo("body").data("builder",t)}n?(i.show(),e=i.outerWidth(!0),h.css("right",e),$(".cloud-model-container").css("margin-right",e),t.updateMasterDetailInfo(i)):(i.hide(),h.css("right",""),$(".cloud-model-container").css("margin-right",""));t.hosted()&&window.external.UIState("MasterDetail",n);t.scale()}else if(n.suggestion)o||(o=c.details=[]),r=n.suggestion.table,window.external.Confirm('The detail relationship with the model "'+t.toModelName(r.name)+'" will be created.\n\nProceed?')&&(s=[],r.foreignKeys[n.suggestion.foreignKeyIndex].foreignKey.forEach(function(n){s.push(n.columnName)}),f={_type:"detail",fieldName:t.toFieldName(r.name),model:t.toModelName(r.name),filterFields:s.join(),create:!0,edit:!0},o.push(f),u=r.schema,u&&(u+="."),u+=r.name,f.model!==window.external.ModelName&&window.external.CreateOrUseExistingModel(f.model,u)||t.updateMasterDetailInfo());else if(n.model)window.external.OpenModel(n.model);else if(n.detail!=null)switch(n.action){case"show":t.showDetail(n.detail)}},showDetail:function(n){$(".cloud-model-detail").remove();var u=this,r=u._model.details,t=r[n],i=[];i.push('<div class="cloud-model-detail" data-input-container="detail" data-detail-index="',n,'">');i.push('<div class="cloud-model-toolbar">','<i class="material-icon'+(n==0?r.length===1?" app-hidden":" app-disabled":"")+'" title="Move Up" data-action="up">arrow_upward<\/i>','<i class="material-icon'+(n==r.length-1?r.length===1?" app-hidden":" app-disabled":"")+'" title="Move Down" data-action="down">arrow_downward<\/i>','<i class="material-icon" title="Delete" data-action="delete">delete<\/i><\/div>');i.push('<div class="cloud-input-label">Name:<\/div>');i.push('<div class="cloud-input-value" data-input="text" data-field="fieldName"><span class="cloud-input-inner">',p(t.fieldName),"<\/span><\/div>");i.push('<div class="cloud-input-label">Label:<\/div>');i.push('<div class="cloud-input-value',w(t.label)?" cloud-empty":"",'" data-input="text" data-field="label"><span class="cloud-input-inner">',p(w(t.label)?"none":t.label),"<\/span><\/div>");i.push('<div class="cloud-input-label">Tab:<\/div>');i.push('<div class="cloud-input-value',w(t.tab)?" cloud-empty":"",'" data-input="text" data-field="tab"><span class="cloud-input-inner">',p(w(t.tab)?"none":t.tab),"<\/span><\/div>");i.push("<div>",'<span class="cloud-checkbox" data-field="flow">','<i class="material-icon">',d(t.flow),"<\/i>Start a new row in the display flow.<\/span>","<\/span><br/>",'<span class="cloud-checkbox" data-field="edit" title="Details can be entered while\nediting an existing master.">','<i class="material-icon">',d(t.edit),"<\/i>Edit<\/span>","<\/span>",'<span class="cloud-checkbox" data-field="create" title="Details can be entered\nwith the new master.">','<i class="material-icon">',d(t.create),"<\/i>Create<\/span>","<\/span>",'<span class="cloud-checkbox" data-field="list" title="Details are available when\na master is selected in the list.">','<i class="material-icon">',d(t.list),"<\/i>List<\/span>","<\/span>","<\/div>");i.push("<\/div>");$(i.join("")).insertAfter($('[data-detail-index="'+n+'"]').parent())},updateMasterDetailInfo:function(n){var r,u;n||(n=$(".cloud-model-panel-masterdetail"));var i=this,f=i._model,e=f.details||[],o=[],h=i._database,c=f.baseSchema,l=f.baseTable,t=[],s=JSON.parse(window.external.EnumerateModels());t.push('<div class="cloud-text">');t.push('<div class="cloud-title">Details<\/div>');e.length?e.forEach(function(n,i){o.push(n.model);t.push("<p>");t.push('<span data-type="detail" data-detail-index="',i,'" title="View Field">');t.push(p(n.fieldName));t.push("<\/span>");t.push(" field based on ");t.push('<span data-type="model" data-model-name="',n.model,'" title="View Model">');t.push(n.model);t.push(" (");t.push((n.filterFields||"").replace(/,/,", "));t.push(")");t.push("<\/span>");t.push("<\/p>")}):t.push("<p>","None.","<\/p>");r=[];h.dataModel.forEach(function(n,t){var u=n.foreignKeys;u&&u.forEach(function(u,f){u.parentTableSchema===c&&u.parentTableName===l&&o.indexOf(i.toModelName(n.name))===-1&&r.push({table:n,fk:u,tableIndex:t,fkIndex:f})})});r.length&&(t.push('<div class="cloud-title">Suggestions<\/div>'),r.forEach(function(n){t.push("<p>");t.push('<span data-type="suggestion" data-table-index="',n.tableIndex,'" data-foreign-key-index="',n.fkIndex,'" title="Add suggestion to details.">');i._schemas.length>1&&t.push(p(n.table.schema),".");t.push(p(n.table.name));t.push(" (");n.fk.foreignKey.forEach(function(n,i){i&&t.push(", ");t.push(p(n.columnName))});t.push(")");t.push("<\/span>");t.push("<\/p>")}));u=[];s.list.forEach(function(n){var i=n.details,t;i&&i.every(function(i){return t=i.model===s.thisModel,t&&u.push(n.model),!t})});t.push('<div class="cloud-title">Masters<\/div>');u.length?u.forEach(function(n){t.push("<p>");t.push('<span data-type="model" data-model-name="',n,'" title="View Model">');t.push(n);t.push("<\/span>");t.push("<\/p>")}):t.push("<p>","None.","<\/p>");t.push("<\/div>");$(t.join("")).appendTo(n.empty())},addTable:function(n){var t=this,o=t._diagram,c=t._list,l=c.find(".cloud-grid"),r=c.find(".cloud-model-panel-tables"),v;if(!arguments.length)return r.length>0&&r.is(":visible");if(typeof n=="boolean"){if(!r.length){if(n===!1)return;r=$('<div class="cloud-model-panel cloud-model-panel-tables"><\/div>').appendTo(c).height(l.outerHeight(!0));v=$('<ul class="cloud-model-table-list"/>').appendTo(r);$(t._database.dataModel).each(function(){var n=this,r=t.findTableElement(n),i,u;i=$('<li draggable="true"/>').appendTo(v).text(s(n.schema,n.name)).attr({"data-schema":n.schema,"data-table":n.name});i.attr("title",i.text());u=$('<span class="cloud-model-table-ref-count"/>').appendTo(i).text(r.length);r.length?i.addClass("cloud-model-table-ref"):u.hide()});$('<div class="cloud-model-clear"><\/div>').appendTo(r)}n?(t.formulaField()&&t.formulaField(!1),l.css("visibility","hidden"),r.show(),r.scrollTop(r.data("scrollTop")||0)):(l.css("visibility",""),r.data("scrollTop",r.scrollTop()).hide());t.hosted()&&window.external.UIState("AddTable",n)}else{t.scale(!1);var e=t.findTableElement(n),u=(n.id||n.name).replace(/\s*/g,""),y,a=t._scaleRatio;u.match(/\d$/)&&(u+="_");(t._model.alias===u||t._foreignKeyMap[u])&&(u+=e.length);y={_type:"foreignKey",id:u,parentTableSchema:n.schema,parentTableName:n.name,foreignKey:[],x:n.x!=null?n.x/a:t.diagramSize().width-i+h,y:n.y!=null?n.y/a:i};t._model.foreignKeys.push(y);t.setupMappings();t._right=0;t.renderMasterTables();$(".cloud-model-highlight").removeClass("cloud-model-highlight");e=t.findTableElement({foreignKey:u}).addClass("cloud-model-highlight");o.width(t._right);t._bottom=Math.max(t._bottom,i+e.outerHeight());o.height(t._bottom);b({element:t._canvas,width:t._right,height:t._bottom});t.updateStateOfConnectors();t.scale(!0);n.x==null&&o.parent().scrollTop(0).scrollLeft(t._right*a-f.width());setTimeout(function(){e.removeClass("cloud-model-highlight")},1500);t.updateTableRefCount(n)}},diagramScroll:function(){var n=this._diagram.parent();return{left:n.scrollLeft(),top:n.scrollTop()}},diagramSize:function(){var r=this,n=0,t=0,u=r.diagramScroll();return r._diagram.find(".cloud-model-table").each(function(){var r=$(this),f=r.offset();n=Math.max(n,u.left+f.left+r.outerWidth()+i);t=Math.max(t,u.top+f.top+r.outerHeight()+i)}),{width:n,height:t}},linkTables:function(t,i){function k(n){var t;return n.foreignKey.length&&(t=!0),t||$(u._model.foreignKeys).each(function(){if(this.baseForeignKey==n.id&&k(this))return t=!0,!1}),t}var u=this,a,s=$(t).closest(".cloud-model-column"),l=s.closest(".cloud-model-table"),r=u._foreignKeyMap[l.attr("data-foreign-key")],e,p=l.attr("data-table"),w=l.attr("data-schema"),f=n.data,h,c,v,y,o=!0,b;return s.length&&r&&r.id!=f.alias&&(v=u.findTableModelInfo(w,p),h=u.findColumnModel(w,p,s.attr("data-column")),y=u.findTableModelInfo(f.schema,f.table),c=u.findColumnModel(f.schema,f.table,f.column),e=u._foreignKeyMap[f.alias],tt(h,!1)!=tt(c,!1)&&i!=!0&&(o=!1),!e&&r.baseForeignKey&&(o=!1),e&&r.baseForeignKey&&e.id!=r.baseForeignKey&&(o=!1),r&&r.baseForeignKey&&e&&e.baseForeignKey&&e.id!=r.baseForeignKey&&(o=!1),o&&e&&r&&r.foreignKey.length&&e.id!=r.baseForeignKey&&k(r)&&(o=!1),o&&$(r.foreignKey).each(function(){var n=this;n.columnName==c.name&&n.parentColumnName==h.name&&(b=!0)}),o&&(b||(f.rollback&&(f.rollback(),r=u._foreignKeyMap[r.id]),f.rollbackData=JSON.stringify(r),f.rollback=function(){u.scale(!1);u.connector(r,!1);var n=u._model,t=n.foreignKeys.indexOf(r);eval("parentFK="+f.rollbackData);n.foreignKeys.splice(t,1,r);u.setupMappings();u.connector(r,!0);u.updateConnectors();u.scale(!0);s.removeClass("cloud-model-column-selected")},f.commit=function(){s.removeClass("cloud-model-column-selected")},u.scale(!1),u.connector(r,!1),$(r.foreignKey).each(function(n){var t=this;if(t.parentColumnName===h.name||c.name===t.columnName)return r.foreignKey.splice(n,1),!1}),r.baseForeignKey=e?e.id:null,r.foreignKey.push({_type:"foreignKeyColumn",columnName:c.name,parentColumnName:h.name}),y.tableModel.primaryKey.length===1&&y.tableModel.primaryKey[0].columnName===c.name&&v.tableModel.primaryKey.length===1&&v.tableModel.primaryKey[0].columnName===h.name&&(r.type="1-to-1"),u.setupMappings(),u.connector(r,!0),u.updateConnectors(),u.scale(!0),s.addClass("cloud-model-column-selected")),l.addClass("cloud-model-drop-target"),a=!0)),a||(f.rollback&&(f.rollback(),f.rollback=null),$(".cloud-model-drop-target").removeClass("cloud-model-drop-target")),a},removeTable:function(n){var t=this,i=t._model.foreignKeys,r=t._foreignKeyMap[n];t.scale(!1);t.removeForeignKey(n);t._diagram.find('.cloud-model-table[data-foreign-key="'+n+'"]').remove();$(i).each(function(){var i=this;i.baseForeignKey==n&&(t.removeForeignKey(i.id),i.baseForeignKey=null)});i.splice(i.indexOf(r),1);t.setupMappings();t.updateConnectors();t.scale(!0);t.updateTableRefCount({name:r.parentTableName,schema:r.parentTableSchema})},updateTableRefCount:function(n){var t=$('.cloud-model-table-list [data-table="'+n.name+'"][data-schema="'+n.schema+'"] .cloud-model-table-ref-count'),i=this.findTableElement(n);i.length?t.show().text(i.length).parent().addClass("cloud-model-table-ref"):t.hide().parent().removeClass("cloud-model-table-ref")},removeForeignKey:function(n,t){var i=this,r=i._foreignKeyMap[n],u=i._fieldGrid,f=u.rows();if(t&&i.scale(!1),i.connector(r,!1),t?$(r.foreignKey).each(function(n){var i=this;if(i.parentColumnName==t)return r.foreignKey.splice(n,1),!1}):r.foreignKey=[],!r.foreignKey.length){function e(n){var t=[],r=[],o=i._model.columns,u=i._foreignKeyMap[n];$(i._model.foreignKeys).each(function(){this.baseForeignKey==n&&e(this.id)});$(f).each(function(){var i=this;i.TableAlias==n&&(t.push(i.FieldName),r.push(i.ColumnName))});$(f).each(function(){var n=this;n.AliasFieldName&&t.indexOf(n.AliasFieldName)!=-1&&(n.AliasFieldName=null)});$(r).each(function(){i.removeField({tableAlias:n,columnName:this,tableName:u.parentTableName,schema:u.parentTableSchema,silent:!0})})}e(r.id);u.refresh()}r.foreignKey.length||(r.baseForeignKey=null);t&&i.setupMappings();i.connector(r,!0);t&&(i.updateConnectors(),i.scale(!0))},_refresh:function(){var n=this;n.scale(!1);n.renderBaseTable();n.renderMasterTables();n.updateConnectors();n._fieldGrid.refresh();n.scale(!0)},removePrimarKey:function(n){var t=this,u=t.findTableModelInfo(n.schema,n.table),i=u.tableModel,r=t.findColumnModel(n.schema,n.table,n.column);$(t._model.columns).each(function(){var n=this;n.foreignKey||n.name!=r.name||delete n.primaryKey});$(i.primaryKey).each(function(n){var t=this;if(t.columnName==r.name)return i.primaryKey.splice(n,1),!1});delete u.primaryKey[r.name];t._diagram.find('.cloud-model-table[data-table="'+i.name+'"][data-schema="'+i.schema+'"]').remove();t._refresh()},setPrimarKey:function(n){var t=this,u=t.findTableModelInfo(n.schema,n.table),i=u.tableModel,r=t.findColumnModel(n.schema,n.table,n.column),f={_type:"primaryKeyColumn",columnName:r.name,isVirtual:!0};$(t._model.columns).each(function(){var n=this;n.foreignKey||n.name!=r.name||(n.primaryKey=!0)});i.primaryKey.push(f);u.primaryKey[r.name]=f;t._diagram.find('.cloud-model-table[data-table="'+i.name+'"][data-schema="'+i.schema+'"]').remove();t._refresh()},changeFieldProperty:function(n){function v(){$(r.sortColumns()).each(function(){var n=this,t=r.field(n.fieldName);t.row.SortType=n.sortType;t.row.SortOrder=n.sortOrder});n.success=function(n){var t=n.closest(".cloud-grid tbody"),i=r.sortColumns();t.find('[data-column="SortType"]').text("");t.find('[data-column="SortOrder"]').text("");$(i).each(function(){var n=this,i=t.find('[data-field="'+n.fieldName+'"]');i.find('[data-column="SortType"]').text(n.sortType);i.find('[data-column="SortOrder"]').text(n.sortOrder)});f.fit()}}function y(n){delete n.column.sortOrder;delete n.column.sortType;n.row.SortType=null;n.row.SortOrder=null}function p(n){var i=r.columnSpec(n.row._schema,n.row._tableName,n.row.ColumnName,n.row.TableAlias),u=n.row.FieldName,e=r._diagram.find(n.row.TableAlias==r._model.alias?".cloud-model-table-base":'.cloud-model-table[data-foreign-key="'+n.row.TableAlias+'"]'),o=e.find('[data-column="'+n.row.ColumnName+'"]'),s=f.findRow({FieldName:u}),h=f.column("Spec"),t;o.find(".cloud-model-column-spec").text(i.text).attr("title",i.tooltip);t=h.value(s);f._tableBody.find('[data-field="'+u+'"] [data-column="Spec"]').text(t.text).attr("title",t.tooltip)}var r=this,s,h=n.name,i=n.value,t=r.field(n.fieldName),f=r._fieldGrid,u=!0,l,o,a,e,c;return n.success=function(n){n.text(i);f.fit()},h=="Label"?i?(t.row.Label=i,t.column.label=i):u="Required":h=="Format"?(i&&r.hosted()&&(u=window.external.ValidateFormatString(i,t.column.dataType||r.findColumnModel(t.row._schema,t.row._tableName,t.row.ColumnName).dataType)),u==!0&&(t.row.Format=i,t.column.format=i)):h=="SortType"?(i||(i="Unsorted"),i.match(/^(ascending|descending|asc|desc|unsorted)$/i)?(i.match(/unsorted/i)?y(t):(s=r.sortColumns(),t.column.sortType=i.match(/^asc/i)?"Ascending":"Descending",t.column.sortOrder||(t.column.sortOrder=s.length?s[s.length-1].sortOrder+1:1)),v()):u='Enter "Ascending", "Descending", or "Unsorted".'):h=="SortOrder"?(i||(i="Unsorted"),i.match(/^(\d+|unsorted)$/i)?(i.match(/^unsorted/i)?y(t):(t.column.sortOrder=null,s=r.sortColumns(),i=parseInt(i),$(s).each(function(){var n=this;n.sortOrder>=i&&n.sortOrder++}),t.column.sortOrder=i,t.column.sortType||(t.column.sortType="Ascending")),v()):u='Enter a numeric value or "Unsorted".'):h=="FieldName"?i?(u=r.validateFieldName(i,[t.row.FieldName]),u==!0&&($(f.rows()).each(function(){var n=this;n.AliasFieldName==t.row.FieldName&&(n.AliasFieldName=i,f._tableBody.find('[data-field="'+n.FieldName+'"] [data-column="AliasFieldName"]').text(i))}),l=[],o=[],r.nameToParts(t.row.FieldName,l),l.join(" ")==t.row.Label&&(r.nameToParts(i,o),o=o.join(" "),t.column.label=o,t.row.Label=o,f._tableBody.find('[data-field="'+t.row.FieldName+'"] [data-column="Label"]').text(o)),t.column.fieldName=i,t.row.FieldName=i,r.setupMappings(),n.textInput.closest("[data-field]").attr("data-field",i))):u="Required.":h=="AliasFieldName"?(a=t.row.AliasFieldName?r.field(t.row.AliasFieldName):null,i?(e=r.field(i),e.row?t.row.FieldName.toLowerCase()==i.toLowerCase()?u="A field cannot be self-aliasing.":e.row.TableAlias?e.row.AliasFieldName?u="Aliased field cannot be used as an alias.":(c=f.findRow({AliasFieldName:e.row.FieldName}),c&&c.FieldName!=t.row.FieldName?u='Field is already used as an alias of "'+c.FieldName+'" field.':(t.row.AliasFieldName=e.row.FieldName,e.row.TableAlias==r._model.alias?delete t.column.aliasColumnName:t.column.aliasForeignKey=e.row.TableAlias,t.column.aliasColumnName=e.row.ColumnName)):u="Formula field cannot be used as alias.":u="Unknown field name."):(delete t.column.aliasForeignKey,delete t.column.aliasColumnName,t.row.AliasFieldName=null),u==!0&&(r.setupMappings(),a&&p(a),e&&p(e),n.success=function(n){var t=n.closest(".cloud-grid tbody");t.find('[data-column="AliasFieldName"]').text("");$(f.rows()).each(function(){var n=this;n.AliasFieldName&&t.find('[data-field="'+n.FieldName+'"] [data-column="AliasFieldName"]').text(n.AliasFieldName)});f.fit()})):u="Not supported",u!=!0&&(n.success=null),u},sortColumns:function(){var t=this,n=[];return $(t._model.columns).each(function(){var t=this;t.sortOrder!=null&&n.push(t)}),n.sort(function(n,t){var i=n.sortOrder?parseInt(n.sortOrder):0,r=t.sortOrder?parseInt(t.sortOrder):0;return i-r}),$(n).each(function(n){this.sortOrder=n+1}),n},changeTableAlias:function(n){var t=this,i=n.newTableAlias,u=n.tableAlias,r,f=[t._model.alias.toLowerCase()];return(i||(r="Required"),r||i.match(/^[a-z][a-z0-9_]*$/i)||(r='A table alias must start with a letter and contain alpha-numeric characters and "_".'),!r&&i.length>t._database.nameMaxLength&&(r="The table name is too long."),r||($(t._model.foreignKeys).each(function(){f.push(this.id.toLowerCase())}),f.indexOf(i.toLowerCase())!=-1&&(r="Duplicate table alias.")),r)?r:(u==t._model.alias?(t._model.alias=i,$(".cloud-model-table-base").remove()):(t._foreignKeyMap[u].id=i,$('.cloud-model-table[data-foreign-key="'+u+'"]').remove(),$('[data-connector="'+u+'"]').attr("data-connector",i)),$(t._model.columns).each(function(){var n=this;n.foreignKey==u&&(n.foreignKey=i);n.aliasForeignKey==u&&(n.aliasForeignKey=i)}),$(t._fieldGrid.rows()).each(function(){var n=this;n.TableAlias==u&&(n.TableAlias=i)}),$(t._model.foreignKeys).each(function(){var n=this;n.baseForeignKey==u&&(n.baseForeignKey=i)}),t.setupMappings(),t._fieldGrid.refresh(),t.scale(!1),t.renderBaseTable(),t.renderMasterTables(),t.updateConnectors(),t.scale(!0),!0)},showContextMenu:function(t){function c(n){var i=!1;return w||(u=$(t.target).closest(n),u.length&&(w=!0,i=!0)),i}var i=this,a=i._model,w,b,r=[],h={x:t.pageX,y:t.pageY},rt,u,k;if(modelBuilder_hideTooltip(),v(),rt=$(t.target),c("[data-connector]")&&(k=u.attr("data-connector"),r.push({text:'Disconnect from "'+k+'"',context:{id:k,column:u.attr("data-parent-column")},callback:function(n){i.removeForeignKey(n.id,n.column)}})),c(".cloud-model-column")){var l=u.closest(".cloud-model-table"),y=l.attr("data-foreign-key"),d=y||i._model.alias,g=i.findTableModelInfo(l.attr("data-schema"),l.attr("data-table")),o=g.tableModel,e=i.findColumnModel(o.schema,o.name,u.attr("data-column")),p;(!y||i._foreignKeyMap[y].foreignKey.length)&&r.push({text:u.is(".cloud-model-column-selected")?"Remove From Model":"Add Column To Model",callback:function(){var n=u.find(".cloud-model-column-name").trigger("click");setTimeout(function(){var t=n.data("title");t&&n.attr("title",t)},500)}});l.is(".cloud-model-table-base")&&(!o.primaryKey.length||o.primaryKey[0].isVirtual)&&(p={schema:o.schema,table:o.name,column:e.name},g.primaryKey[e.name]?r.push({text:"Remove Primary Key",context:p,callback:function(){i.removePrimarKey(p)}}):r.push({text:"Set Primary Key",context:p,callback:function(){i.setPrimarKey(p)}}));$(g.foreignKeys).each(function(){var t=this[e.name];t&&($(a.foreignKeys).each(function(){return t.info.parentTableName==this.parentTableName&&t.info.parentTableSchema==this.parentTableSchema&&y==this.baseForeignKey&&$(this.foreignKey).each(function(){this.columnName==e.name&&(t=null)}),t?void 0:!1}),t&&r.push({text:'Connect to "'+s(t.info.parentTableSchema,t.info.parentTableName)+'"',context:t.info,callback:function(){var f=l.attr("data-foreign-key")||"",u=e.name,r,c,s,y,h;u.length>2&&(u=u.replace(/\_(ID|PK|FK|GUID)$/i,""),u.match(/[a-z]/)&&(u=u.replace(/(Id|ID|Pk|PK|Fk|FK|Guid)$/,"")));r=u;i._foreignKeyMap[r]&&((f.match(/\_/)||r.match(/\_/)||f&&!(f.match(/[A-Z]/)&&f.match(/[a-z]/)))&&(r="_"+r),r=f+r,r.length>i._database.nameMaxLength&&(r=u));i.addTable({id:r,schema:t.info.parentTableSchema,name:t.info.parentTableName});c=a.foreignKeys[a.foreignKeys.length-1];$(t.info.foreignKey).each(function(){var n=this;if(n.columnName==e.name)return y=n.parentColumnName,!1});s=i._diagram.find('.cloud-model-table[data-foreign-key="'+c.id+'"]');h=s.find('.cloud-model-column[data-column="'+y+'"]');n={data:{alias:l.attr("data-foreign-key"),schema:o.schema,table:o.name,column:e.name}};ut(s);i.linkTables(h);n=null;s.removeClass("cloud-model-drop-target");h.removeClass("cloud-model-column-selected");setTimeout(function(){v()},500)}}))});$(a.foreignKeys).each(function(){var n=this;n.baseForeignKey==y&&$(n.foreignKey).each(function(){var t=this;t.columnName==e.name&&r.push({text:'Disconnect from "'+n.id+'"',context:{id:n.id,column:t.parentColumnName},callback:function(n){i.removeForeignKey(n.id,n.column)}})})});r.push({text:"Add As Formula Field",callback:function(){i.formulaField({newFieldName:d+(d.match(/\_/)?"_":"")+e.name,formula:d+"."+i.quotedName(e.name)})}});h.hideArrow=!0}if(c(".cloud-model-table")&&(r.push({text:"Rename Alias",callback:function(){u.find("th[data-input] [data-input-hotspot]").trigger("click")}}),u.is(".cloud-model-table-base")||r.push({text:"Delete Table",context:u.attr("data-foreign-key"),callback:function(n){i.removeTable(n)}}),u.find(":input").length>u.find(":checked").length&&r.push({text:"Add All Columns",callback:function(){i.forEachField(u.attr("data-foreign-key"),"add")}}),u.find(":checked").length&&r.push({text:"Remove All Columns",callback:function(){i.forEachField(u.attr("data-foreign-key"),"remove")}}),h.hideArrow=!0),c(".cloud-model-list .cloud-grid-body tbody td")){var nt=u.closest("tr"),tt=nt.index(),f=i._fieldGrid.rows()[tt];f&&(nt.closest(".cloud-grid").find("tbody").find("tr:eq("+tt+")").addClass("cloud-model-inspected"),modelBuilder_showFieldOnDiagram(nt.attr("data-field")),f.TableAlias||r.push({text:"Edit Formula",callback:function(){i.formulaField({fieldName:f.FieldName,formula:f.SqlFormula})}}),u.is('[data-column="FieldName"]')||(b=f.FieldName),r.push({text:"Remove From Model",callback:function(){f.TableAlias?i._diagram.find(".cloud-model-table"+(f.TableAlias==a.alias?".cloud-model-table-base":'[data-foreign-key="'+f.TableAlias+'"]')+' [data-column="'+f.ColumnName+'"] .cloud-model-column-name').trigger("click"):i.removeField({fieldName:f.FieldName})}}),f.TableAlias&&r.push({text:"Add As Formula Field",callback:function(){i.formulaField({newFieldName:f.FieldName,formula:f.TableAlias+"."+i.quotedName(f.ColumnName)})}}))}return c(".cloud-model-container")&&((i.addTable()||i.formulaField())&&r.push({text:"Show Model Fields",callback:function(){modelBuilder_addTable(!1);modelBuilder_formulaField(!1)}}),i.addTable()||r.push({text:"Add Table",callback:function(){modelBuilder_addTable(!0)}}),i.formulaField()||r.push({text:"Add Formula Field",callback:function(){modelBuilder_formulaField(!0)}}),i.formulaField()||r.push({text:i._model.where?"Change Filter":"Add Filter",callback:function(){i.whereClause(!0)}}),r.push({text:"Arrange Tables",callback:function(){confirm("Arrange Tables?")&&modelBuilder_arrangeTables()}}),h.hideArrow=!0),c(".cloud-model-panel-tables")&&i.addTable()&&(r.push({text:"Show Model Fields",callback:function(){modelBuilder_addTable(!1)}}),h.hideArrow=!0),w&&r.length&&(u.addClass("cloud-model-inspected"),u.is(".cloud-model-connector")&&it(u,"cloud-model-inspected"),b&&(h.title=b),h.items=r,oi(h)),w},diagramWidth:function(n){var t=this;if(!arguments.length)return t._right;n>t._right&&(t._right=n,t._diagram.width(n),b({element:t._canvas,width:n}))},diagramHeight:function(n){var t=this;if(!arguments.length)return t._bottom;n>t._bottom&&(t._bottom=n,t._diagram.height(n),b({element:t._canvas,height:n}))}};$(document).on("click",'[data-type="suggestion"]',function(){var n=$(this),t=k(n);return t.masterDetail({suggestion:{table:t._database.dataModel[n.data("table-index")],foreignKeyIndex:n.data("foreign-key-index")}}),!1}).on("click",'[data-type="model"]',function(){return k(this).masterDetail({model:$(this).data("model-name")}),!1}).on("click",'[data-type="detail"]',function(){var n=$(this),t=$('[data-input-container="detail"][data-detail-index="'+n.data("detail-index")+'"]');return t.length?t.remove():k(n).masterDetail({detail:n.data("detail-index"),action:"show"}),!1}).on("click",".cloud-input-label",function(){$(this).next().trigger("click")}).on("getvalue.input.app",'[data-input-container="detail"] [data-field]',function(n){var t=ft(this);n.inputValue=t[$(this).data("field")]}).on("setvalue.input.app",'[data-input-container="detail"] [data-field]',function(n){var i=$(this),u=k(this),f=ft(i,!0),e=i.data("field"),t=n.inputValue,o=i.find(".cloud-input-inner"),r;e==="fieldName"&&(r=k(this).validateFieldName(t),r!==!0?n.inputValid=!1:setTimeout(function(){u.updateMasterDetailInfo();u.masterDetail({detail:f.index,action:"show"})}));n.inputValid?(f.detail[e]=t,o.text(w(t)?"none":t),i.toggleClass("cloud-empty",w(t))):n.inputError=r}).on("click",".cloud-model-detail .cloud-checkbox",function(){var i=$(this),u=i.find("i"),n=u.text()===d(!0),r=ft(i),t=i.data("field");n=!n;u.text(d(n));t==="flow"?n?r[t]="row":delete r[t]:r[t]=n}).on("click",".cloud-model-detail .cloud-model-toolbar .material-icon",function(){var i=$(this),r=i.data("action"),t=k(i),n=ft(i,!0);if(!i.is(".app-disabled"))switch(r){case"delete":window.external.Confirm('Delete "'+n.detail.fieldName+'" field from the model?')&&(n.model.details.splice(n.index,1),t.updateMasterDetailInfo());break;case"up":n.model.details.splice(n.index,1);n.model.details.splice(n.index-1,0,n.detail);t.updateMasterDetailInfo();t.masterDetail({detail:n.index-1,action:"show"});break;case"down":n.model.details.splice(n.index,1);n.model.details.splice(n.index+1,0,n.detail);t.updateMasterDetailInfo();t.masterDetail({detail:n.index+1,action:"show"})}}).on("click",".cloud-model-panel-masterdetail",function(n){$(n.target).closest(".cloud-model-detail").length||$('[data-input-container="detail"][data-detail-index]').remove()})})();